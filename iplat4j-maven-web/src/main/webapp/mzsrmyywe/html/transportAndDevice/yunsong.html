<!doctype html>
<html class="no-js">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="renderer" content="webkit">
  <meta name="HandheldFriendly" content="true" />
  <meta name="MobileOptimized" content="320" />
  <meta name="format-detection" content="telephone=no">
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <link rel="stylesheet" href="../../reference/bootstrap-3.3.5/css/bootstrap.css" />
  <link rel="stylesheet" href="../../reference/mui/css/mui.css" />
  <link rel="stylesheet" href="../../reference/mui/css/mui.min.css" />
  <link rel="stylesheet" href="../../css/common.css">
  <link rel="stylesheet" href="../../css/detail.css">
  <link rel="stylesheet" href="../../reference/assets/css/common.css" type="text/css" charset="utf-8" />
</head>
<style>
  .warns {
    width: 100%;
    background: #000000;
    opacity: 0.3;
  }

  .warnss {
    width: 100%;
    font-size: 19px;
  }

  #topHeader {
    background: #30c37c;
  }

  .aboveDiv,
  .aboveAccept {
    position: absolute;
    z-index: 4999;
    left: 10%;
    top: 24%;
    width: 80%;
    background: #FFFFFF;
    border-radius: 12px;
  }

  .aboveDivss,
  .aboveDivWarn {
    position: absolute;
    z-index: 4999;
    left: 10%;
    top: 27%;
    height: 210px;
    width: 80%;
    background: #FFFFFF;
    border-radius: 12px;
  }

  .aboveDivWarn li {
    width: 100%;
    height: 95px;
    line-height: 95px;
    text-align: center;
    margin-left: -8%;
    border-bottom: 1px solid #E0E0E0;
    font-size: 23px;
  }

  .aboveDivss li {
    width: 100%;
    height: 70px;
    line-height: 70px;
    text-align: center;
    margin-left: -8%;
    border-bottom: 1px solid #E0E0E0;
    font-size: 23px;
  }

  .aboveDiv li,
  .aboveAccept li {
    width: 100%;
    height: 80px;
    line-height: 80px;
    text-align: center;
    margin-left: -8%;
    font-size: 23px;
  }

  #spanLi span {
    display: inline-block;
    width: 50%;
  }

  .qiangdan {
    position: fixed;
    z-index: 99;
    bottom: 60px;
    right: 10px;
    width: 60px;
    height: 60px;
    background: #929191;
    text-align: center;
    border-radius: 50%;
    display: none;
  }

  .panel {
    box-shadow: 3px 3px 10px #ccc;
  }

  /* 抢单按钮 */
  .grab-btn {
    width: 100%;
    background-color: #4fc089;
    color: #fff;
  }

  #toAll {
    margin-top: 87px;
  }

  .mui-toast-container {
    top: 80% !important;
  }
</style>

<body>
  <div id="offCanvasWrapper" class="mui-off-canvas-wrap">
    <!--侧滑菜单部分-->
    <aside id="offCanvasSide" class="mui-off-canvas-left">
      <div id="offCanvasSideScroll" class="mui-scroll-wrapper">
        <div class="mui-scroll">
          <div id="listUl" class="listUl">
          </div>
          <div id="title" class="title"
            style="color:#0090BB;padding: 5px 20px;padding-top:20px;position:fixed;z-index:3000;top:-16px;background:#333333;width:100%;height:45px;text-align: center;font-size: 22px;">
            运送项目<span id="numText" style="float: right;color: #FFFFFF;font-size:18px;"></span></div>
          <button id="offCanvasHide" type="button" class="mui-btn mui-btn-danger mui-btn-block content"
            style="padding: 5px 20px;position:fixed;z-index:3000;bottom:-10px;width:100%;height:45px;text-align: center;">关闭列表</button>
          <div id="warns" class="warns" hidden>
            <small></small>
          </div>
          <div id="warnss" class="warnss" hidden>
            <small></small>
          </div>
        </div>
      </div>
      <p id="pTexts" style="text-align: center;margin-top: 70%;border-top:none;" hidden>加载中，请稍后...</p>
      <span class="mui-spinner mui-spinners" style="height: 50px;width: 50px;margin-left: 40%;color:#FFFFFF;"
        hidden></span>
    </aside>
    <!--主界面部分-->
    <div id="contentMain" class="mui-inner-wrap">
      <header id="topHeader" class="mui-bar mui-bar-nav">
        <h1 class="mui-title">任务列表</h1>
        <button id="back" class="mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left">
          <span class="mui-icon mui-icon-left-nav"></span>
          返回
        </button>
      </header>
      <div id="offCanvasContentScroll" class="mui-content mui-scroll-wrapper">
        <div id="mui-scroll" style="margin-top: -40px;">
          <!--菜单导航-->
          <div id="slider" style="position: fixed;z-index:4000;top:44px;width:100%;border-bottom:1px solid #F1F1F1;">
            <div id="sliderSegmentedControl">
              <div class="row">
                <div id="peijian" name="0" class="col-xs-6 col-sm-6 col-md-6 col-lg-6 center">
                  陪检
                </div>
                <div id="yunsongs" name="1" class="col-xs-6 col-sm-6 col-md-6 col-lg-6 center"
                  style="border-bottom: 2px solid #007AFF;color:#007AFF;">
                  运送
                </div>
              </div>
            </div>
          </div>

          <div id="toAll" class="mui-table-view mui-table-view-chevron" style="background: #F0F0F0;">
          </div>
          <div id='loadMore' name="0" class='alert' role='alert'
            style='background-color:#F5F5F5;height:5rem;line-height:2rem;text-align:center;margin-bottom: 60px;border-bottom: 2px solid #E6E6E6;'>
            加载更多
          </div>
        </div>
        <p id="pText" style="text-align: center;padding-top: 43%;border-top:none;" hidden>加载中，请稍后...</p>
        <span class="mui-spinner" style="height: 50px;width: 50px;margin-left: 42%;" hidden></span>
        <div id="warn" class="warn" hidden>
          <small></small>
        </div>
      </div>
      <!--底部导航-->
      <nav class="mui-bar mui-bar-tab" id="navYun" style="background-color:#fff;border-top:1px solid #B6B6B6;">
        <a class="mui-tab-item mui-tab-items" id="0" href="#">
          <span class="mui-icon mui-icon-arrowthinleft" style="height:25px;width:25px;margin-top: -7px;"></span>
          <span class="mui-tab-label" style="font-size: 17px;">回退</span>
        </a>
        <a class="mui-tab-item mui-tab-items" id="1" href="#">
          <span class="mui-icon mui-icon-checkmarkempty" style="height:25px;width:25px;margin-top: -7px;"></span>
          <span class="mui-tab-label" style="font-size: 17px;">接单</span>
        </a>
        <a class="mui-tab-item mui-tab-items" id="3" href="#">
          <span class="mui-icon mui-icon-refresh" style="height:25px;width:25px;margin-top: -7px;"></span>
          <span class="mui-tab-label" style="font-size: 17px;">刷新</span>
        </a>
        <a class="mui-tab-item mui-tab-items" id="4" href="#">
          <span class="mui-icon mui-icon-paperplane" style="height:25px;width:25px;margin-top: -7px;"></span>
          <span class="mui-tab-label" style="font-size: 17px;">抢单</span>
        </a>
      </nav>
      <div class="mui-off-canvas-backdrop"></div>
    </div>
    <div id="myModal" class="child-window" hidden></div>
    <div id="myModalss" class="child-window" style="background: #000000;opacity: 0.5;" hidden></div>
    <div id="qrcodeParent" style="width:250px;height:400px;" hidden>
      <div style="text-align: center;color:black;margin-bottom: 20px;">
        <img src="../../img/img.jpg" style="border-radius: 25px;height:50px;width:50px;vertical-align: middle;">
        <span id="qrcodeName" style="font-size:20px;margin-top: 25px;color:#000000;"></span>
      </div>
      <div id="qrcode"></div>
      <p style="text-align: center;margin-top: 13px;color:#000000;">扫描上方二维码，进行人员转派</p>
    </div>
    <div class="aboveDiv" style="display: none;">
      <ul id="aboveDiv">
      </ul>
    </div>
    <div class="aboveAccept" style="display: none;">
      <ul id="aboveAccept">
      </ul>
    </div>
    <div class="aboveDivWarn" style="display: none;">
      <ul>
        <li class="items" style="height: 50px;line-height: 50px;font-weight: bold;">提示</li>
        <li class="items" style="padding-left: 12px;">确认自回科室吗？</li>
        <li class="items" id="spanLi" style="height: 65px;line-height: 65px;border-bottom: none;">
          <span id="0">是</span><span id="1">否</span>
        </li>
      </ul>
    </div>
  </div>
  <div id="signature" style="margin-top:-25px;margin-bottom:60px;display: none;">
  </div>
  <div class="modal fade" id="myModalsssssss" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="top: 116px;">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
            &times;
          </button>
          <h4 class="modal-title" id="myModalLabel">
            签字人下方签名
          </h4>
        </div>
        <div class="modal-body js-signature" id="js-signature" style='height:18rem;' data-width="320" data-height="175">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" onclick="clearCanvas()">
            清除
          </button>
          <button type="button" class="btn btn-info" data-dismiss="modal" onclick="saveSignature()">
            确认
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="qiangdan">
    <span class="mui-icon-extra mui-icon-extra-notice" style="color: #FFFFFF;font-size: 45px;margin-top: 7px;"></span>
    <span id="qiangdanNum" class="mui-badge mui-badge-danger shopping-num"
      style=" position: absolute;padding: 3px 0px;text-align: center;width: 18px;height: 18px; right: 10px;top: 5px;">0</span>
  </div>
</body>
<script src="../../reference/bootstrap-3.3.5/js/jquery-2.1.4.js" type="text/javascript"></script>
<script src="../../reference/bootstrap-3.3.5/js/bootstrap.min.js" type="text/javascript"></script>
<script src="../../reference/mui/js/mui.js" type="text/javascript"></script>
<script src="../../js/jquery.qrcode.min.js" type="text/javascript"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../cordova.js"></script>
<script src="../../js/jq-signature.js"></script>
<script type="text/javascript">
  var baseUrl = localStorage.getItem('url');
  var workNo = localStorage.getItem('workNo');
  var workNoss = localStorage.getItem('workNo');
  var workName = localStorage.getItem('name');
  var worKnamess = localStorage.getItem('name');
  var deptCode = localStorage.getItem('deptCode');
  var deptCodess;
  var deptName = localStorage.getItem('deptName');
  var datagroupCode = localStorage.getItem('dataGroupCode');
  var page = 1;
  var rows = 4;
  var classS = "" //当前事项
  var taskType = 'YS',
    deptAcceptCode = '',
    back_signature_accept = '';
  var back_type, back_signature, back_time = '',
    service_score = '',
    ids, billNo, carriageclass, carriageTime, patient_name, timer = null;
  var timeID = null;
  //完成时是否需要扫码确认
  var scanFinish = false;
  $('#pText').show();
  $('.mui-spinner').show();

  ajaxData();
  // //页面初始化15秒后只执行一次
  // setTimeout('myrefresh()', 30000)
  var intervalID = window.setInterval(load_ys_grab_list, 15000);

  function lengthChange() {
    $.ajax({
      url: baseUrl + 'app_carriageAppController.do?queryCarriageRob',
      type: 'post',
      data: {
        workNo: workNo,
        carriageType: 'YS'
      },
      success: function (data) {
        console.log(data);

        if (data.respCode == "200" || data.respCode == 200) {
          console.log("3S刷新一次");

          if (data.obj.length == 0) {
            $("#qiangdanNum").text("0");
            $("#qiangdanNum").hide();
          } else {
            $("#qiangdanNum").text(data.obj.length);
            $("#qiangdanNum").show();
          }
          timeID = setTimeout("lengthChange()", 3000);
        } else {

          $('#warn small').html(data.respMsg);
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
          $("#qiangdanNum").hide();
          $("#qiangdanNum").text("0");
          timeID = setTimeout("lengthChange()", 3000);
        }

      },
      complete: function (XMLHttpRequest, status) {
        if (status == 'timeout') {
          $('#pText').hide();
          $('.mui-spinner').hide();
          $("#loading").hide();
          $('#warn small').html('连接超时，请检查您的网络是否通畅！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        } else if (status == 'warn') {
          $('#pText').hide();
          $('.mui-spinner').hide();
          $("#loading").hide();
          $('#warn small').html('连接失败，服务运行异常！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        }
      }
    })

  }
  mui("body").on("tap", ".qiangdan", function () {
    console.log($("#qiangdanNum").text());
    if ($("#qiangdanNum").text() == 0 || $("#qiangdanNum").text() == "0") {
      $('#warn small').html("暂无抢单信息！");
      $('#warn').show();
      setTimeout("$('#warn').hide()", 3000);
    } else {

      setTimeout("location.href='qiangdanList.html?' + 'YS'", 1500);
    }
  });
//加载运送列表
  function ajaxData() {
    $.ajax({
      url: baseUrl + 'carriage',
      type: 'post',
      data: {
        workNo,
        datagroupCode,
      },
      headers: {
        methodName: "queryBillNoByUser",
        className: "AppCarriage"
      },
      success: function (data) {
        // debugger
        var list = data.map.obj;
        var html = '';
        var array = new Array();
        console.log(data);
        console.log(list);
        if (list) {

          if (list.length < rows) {
            $('#loadMore').text('暂无更多数据');
          } else {
            $('#loadMore').text('加载更多');
          }
          for (var i = 0; i < list.length; i++) {
            var id = isNull(list[i].id);
            var status_code = isNull(list[i].statusCode);
            billNo = isNull(list[i].billNo);
            var createCateView = isNull(list[i].fromDeptName);
            var from_address = isNull(list[i].from_address);
            var from_dept_name = isNull(list[i].carriageAddressName);
            var carriage_class_name = isNull(list[i].carriageClassName);
            var rec_create_time = isNull(list[i].recCreateTime);
            var status_name = isNull(list[i].statusName);
            var execute_user_name = isNull(list[i].recCreatorNo);
            var has_doctor = isNull(list[i].has_doctor);
            var transport_means_class_name = isNull(list[i].transport_means_class_name);
            var urgent = isNull(list[i].urgent);
            var viewDeptName = isNull(list[i].viewDeptName);
            var patient_name = isNull(list[i].recCreatorNo);
            var patient_bed = isNull(list[i].patient_bed);
            var billDesc = isNull(list[i].recCreateTime); //创建时间
            var urgent = isNull(list[i].urgent); //是否加急;
            var carriageClassName = isNull(list[i].carriageClassName);
            var comments = isNull(list[i].comments);
            var tools = isNull(list[i].tools);
            var score = isNull(list[i].score);
            var bedNo = isNull(list[i].bedNo);
            var task_no = isNull(list[i].billNo);
            var index = i + 1;
            var fromDeptNo = isNull(list[i].fromDeptNo);
            html += sendTaskList(urgent, billDesc, index, viewDeptName, createCateView, fromDeptNo, status_code, billNo, from_address, from_dept_name, carriage_class_name, rec_create_time, id, status_code, status_name, patient_name, execute_user_name, transport_means_class_name, carriageClassName, comments, tools, score, bedNo, task_no)
          }
        } else {
          $('#loadMore').text('暂无更多数据');
        }
        $('#name').text(localStorage.getItem('name'));
        $('#toAll').html(html);
        $('#pText').hide();
        $('.mui-spinner').hide();
      },
      complete: function (XMLHttpRequest, status) {
        if (status == 'timeout') {
          $('#pText').hide();
          $('.mui-spinner').hide();
          $("#loading").hide();
          $('#warn small').html('连接超时，请检查您的网络是否通畅！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        } else if (status == 'warn') {
          $('#pText').hide();
          $('.mui-spinner').hide();
          $("#loading").hide();
          $('#warn small').html('连接失败，服务运行异常！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        }
      }
    })
  }

  //运送主工单
  function sendTaskList(urgent, billDesc, index, viewDeptName, createCateView, fromDeptNo, status_code, billNo, from_address, from_dept_name, carriage_class_name, rec_create_time, id, status_code, status_name, patient_name, execute_user_name, transport_means_class_name, carriageClassName, comments, tools, score, bedNo, task_no) {
    // debugger
    var html = "";
    html += "<div id='div-child' class='panel panel-danger' style='margin-bottom:10px;border:1px solid #DEDEDE;'>";
    html += "<div style='margin-bottom:10px;border:none;'>";
    html += "<div id='panel-heading' class='row' style='background:#FFF;border:none;font-size:21px;padding-top:15px;border-bottom:none;'>";
    html += "<div style='padding-left:14px;padding-bottom:5px;font-size:21px'>出发点:</div>"
    html += "<div id='rowss1' taskIds='" + id + "' carriageClass='" + carriage_class_name + "' carriageTime='" + rec_create_time + "'  class='col-xs-6 col-sm-6 col-md-6 col-lg-6' style='padding-top:4px;'>";
    html += "<span class='detail' style='color:#007AFF;'>" + createCateView + "</span></div>";
    html += "<div class='col-xs-6 col-sm-6 col-md-6 col-lg-6 right'>";
    html += "<div style='padding-bottom:5px;margin-top:-25px;font-size:18px'>科室编码:"
    html += "<span class='detail' style='color:#007AFF;'>" + fromDeptNo + "</span></div>";
    // 完成
    if (status_code == '04') {
      html += "<span style='display:inline-block;padding-top:4px;padding-right:8px;color:#0090BB;'>" + status_name + "</span>";
    } else {
      html += "<span style='display:inline-block;padding-top:4px;padding-right:8px;color:#F5A224;'>" + status_name + "</span>";
    }
    if (status_code != "01") {
      html += "<div id='checkedDivs' name='0' task_no='" + task_no + "' status_code='" + status_code + "' class='" + id + "' billNo='" + billNo + "' fromDept_No='" + fromDeptNo + "'  style='width:125px;height:75px;background:transparent;position:absolute;z-index:3000;top:0;right:0;'></div>";
      html += "<div id='checkedDivsg' style='display:inline-block;border:1px solid #DEDEDE;border-radius:3px;width:25px;height:25px;float:right;'></div>";
      html += "</div></div>";
    } else {
      html += "<div id='checkedDivs' name='0' task_no='" + task_no + "' fromDept_No='" + fromDeptNo + "'  status_code='" + status_code + "' class='" + id + "' billNo='" + billNo + "' style='width:125px;height:75px;background:transparent;position:absolute;z-index:3000;top:0;right:0;'></div>";

      html += "</div></div>"
    }
    html += "<div class='panel-bodys' taskIds='" + id + "' carriageClass='" + carriage_class_name + "'  carriageTime='" + rec_create_time + "'    style='border-bottom:none;border-top:none;'>";
    html += "<div class='row' style='margin-top:-4px;padding-top:16px;font-size:21px;padding-bottom:2px;'>";



    html += "</div></div>";
    if (urgent != "") {
      html += "<div style='padding-left:14px;padding-bottom:5px;font-size:21px'>目的点:</div>";
      html += "<div class='col-xs-12 col-sm-12 col-md-12 col-lg-12' style='padding-top: 5px;padding-bottom: 10px;font-size:20px;color:#007AFF;'>" + from_dept_name + "</div>";
    } else {
      html += "<div style='padding-left:14px;padding-bottom:5px;font-size:21px'>目的点:</div>";
      html += "<div class='col-xs-12 col-sm-12 col-md-12 col-lg-12' style='padding-top: 5px;padding-bottom: 10px;font-size:20px;color:#007AFF;'>" + from_dept_name + "</div>";
    }
    html += "</div>";
    html += "<div style='margin:5px 0 5px 14px;padding-bottom:5px;font-size:21px'><span>运送物品:</span><span style='color:#e4134b'>" + carriageClassName + "</span></div>"
    html += "<div style='margin:5px 0 5px 14px;padding-bottom:5px;font-size:21px'><span>运送备注:</span><span style='color:#e4134b'>" + comments + "</span></div>"
    //******************
    html += "<div  style='border-bottom:none;border-top:none;'>";
    html += "<div class='row' style='margin-top:-4px;padding-top:8px;font-size:21px;  padding-bottom: 3px;line-height: 25px;'>";
    if (billDesc != "") {

      html += "<span class='col-xs-8 col-sm-8 col-md-8 col-lg-8 font-grey'>" + billDesc + "</span>";
    } else {
      html += "<span class='col-xs-8 col-sm-8 col-md-8 col-lg-8 font-grey'></span>";
    }
    if (patient_name != "") {
      html += "<span class='col-xs-4 col-sm-4 col-md-4 col-lg-4 font-grey'>" + patient_name + "</span>";
    } else {
      html += "<span class='col-xs-4 col-sm-4 col-md-4 col-lg-4 font-grey'></span>";
    }
    if (status_code == '01') {
      html += "<div id='grab'><button type='button' taskIds='" + id + "' class='mui-btn grab-btn'>抢单</button>";
      html += "</div>"
    } else {

    }
    html += "</div></div></div>";
    //***********

    return html;
  }

  //加载更多
  var loadMores = document.getElementById("loadMore");
  loadMores.addEventListener('tap', function () {
    if ($('#loadMore').text().trim() == '加载更多') {
      rows += 4;
      if (classS == "4") {
        load_ys_grab_list()
      } else {
        ajaxData();
      }
      $('#loadMore').text('正在加载中...');
    }
  }, false);

  //运送
  mui('#toAll').on('tap', 'div.panel-bodys', function () {

    $('#listUl').html('');
    clearTimeout(timer);
    var valuessT = $(this).parent().parent().find('div#checkedDivs').attr('name');
    ids = this.getAttribute('taskIds');
    carriageclass = this.getAttribute('carriageclass');
    carriageTime = this.getAttribute('carriageTime');
    patient_name = $(this).attr('patient_name');
    console.log('patient_name:', patient_name);
    console.log('ids :', ids);

    $(this).parent().parent().css('background', 'darkgray').siblings('div#div-child').css('background', '');
    $(this).parent().parent().find('div#panel-heading').css('background', 'darkgray');
    $(this).parent().parent().siblings('div#div-child').find('div#panel-heading').css('background', '');
    //打开菜单
    $('#pTexts').show();
    $('.mui-spinners').show();
    offCanvasWrapper.offCanvas('show');
    timer = setTimeout('listPJ()', 500);
  })
//运送弹出侧边子单栏点击事件
  mui('#toAll').on('tap', 'div#rowss1', function () {
    $('#listUl').html('');
    clearTimeout(timer);
    var valuessT = $(this).siblings('div').find('div#checkedDivs').attr('name');
    ids = this.getAttribute('taskIds');
    carriageclass = this.getAttribute('carriageclass');
    carriageTime = this.getAttribute('carriageTime');
    patient_name = $(this).attr('patient_name');
    $(this).parent().parent().parent().css('background', 'darkgray').siblings('div#div-child').css('background', '');;
    $(this).parent().parent().parent().find('div#panel-heading').css('background', 'darkgray');
    $(this).parent().parent().parent().siblings('div').find('div#panel-heading').css('background', '');
    //打开菜单
    $('#pTexts').show();
    $('.mui-spinners').show();
    offCanvasWrapper.offCanvas('show');
    timer = setTimeout('listPJ()', 500);
  })
  function isNull(param) {
    var newParam = param && param != 'undefined;' ? param : '--'
    return newParam
  }
  //子工单显示函数
  function listPJ() {
    $('#pTexts').show();
    $('.mui-spinners').show();
    $.ajax({
      url: baseUrl + 'carriage',
      type: 'post',
      data: {
        billId: ids
      },
      headers: {
        "methodName": "queryBillItem",
        "className": "AppCarriage"
      },
      success: function (data) {
        //debugger
        var list = data.map.obj;
        var lengthList = list.length;
        var html = "";
        if (data.respCode == '200' || data.respCode == 200) {
          for (var i = 0; i < list.length; i++) {
            if (i < 9) {
              var b = i + 1;
              var a = '0' + b;
            } else {
              var a = i + 1;
            }

            if (list[i].carriageAddressName.length > 10) {
              var dected_class_name = list[i].carriageAddressName.substring(0, 9) + '...';
            } else {
              var dected_class_name = list[i].carriageAddressName;
            }
            var id = isNull(list[i].id);
            var comment = isNull(list[i].comment);
            var statusName = isNull(list[i].name);
            var carriageclass = isNull(list[i].carriageClassName)
            var carriageAddress_No = isNull(list[i].carriageAddressNo)
            html += "</br>";
            html += "<span class='lis'>";
            html += "<li class='lisBlew' name='0' style='font-size:18px;text-align:left;padding-left:55px;padding-top:19px;padding-bottom:45px;position:relative;'>" + a + " . " + dected_class_name + "<span class='mui-icon mui-icon-arrowdown' style='float:right;margin-right:30px;margin-top:-3px;'></span>";
            html += "</li>";
            html += "<span id='blewDiv' hidden>";
            //***********************
            //子工单详情内容
            html += "<li style='text-align:left;padding-left:80px;height:40px;border-bottom:none;list-style: none;'>";
            html += "<p style='font-size:18px;'>运送状态:<span style='float:right;margin-right:30px;font-size:16x;display: inline-block;width: 51%;white-space: nowrap;text-overflow: ellipsis;overflow: hidden;'>" + statusName + "</span></p>";
            html += "</li>";

            html += "<li style='text-align:left;padding-left:80px;height:40px;border-bottom:none;list-style: none;'>";
            html += "<p style='font-size:18px;'>运送物品:<span style='float:right;margin-right:30px;font-size:16x;display: inline-block;width: 51%;white-space: nowrap;text-overflow: ellipsis;overflow: hidden;'>" + carriageclass + "</span></p>";
            html += "</li>";

            html += "<li style='text-align:left;padding-left:80px;height:40px;border-bottom:none;list-style: none;'>";
            html += "<p style='font-size:18px;'>运送备注:<span style='float:right;margin-right:30px;font-size:16x;display: inline-block;width: 51%;white-space: nowrap;text-overflow: ellipsis;overflow: hidden;'>" + comment + "</span></p>";
            html += "</li>";

            html += "<li id='zi_li'  carriageAddress_id='" + id + "' carriageAddress_No='" + carriageAddress_No + "' style='text-align:left;padding-left:80px;height:40px;border-bottom:none;list-style: none;'>";
            html += "<p style='font-size:18px;'>送达科室编码:<span style='float:right;margin-right:30px;font-size:16x;display: inline-block;width: 51%;white-space: nowrap;text-overflow: ellipsis;overflow: hidden;'>" + carriageAddress_No + "</span></p>";
            html += "</li>";
            html += "<div style='display:flex ; width:100%'><button taskIds='" + id + "' class='child_order' onclick='child_tras(\"" + id + "\")' style='background:white;width:60%;font-size:14px;margin-left:28%'>完工</button></div>"
  
            html += "</span></span>";
          }
          $('#numText').text('共:' + lengthList);
          $('#pTexts').hide();
          $('.mui-spinners').hide();
          $('.listUl').html(html);
        }
      },
      complete: function (XMLHttpRequest, status) {
        if (status == 'timeout') {
          $("#loading").hide();
          $('#pTexts').hide();
          $('.mui-spinners').hide();
          $('#warn small').html('连接超时，请检查您的网络是否通畅！');
          $('#warn').fadeIn(500);
          setTimeout("$('#warn').fadeOut(500)", 3000);
        } else if (status == 'warn') {
          $("#loading").hide();
          $('#pTexts').hide();
          $('.mui-spinners').hide();
          $('#warn small').html('连接失败，服务运行异常！');
          $('#warn').fadeIn(500);
          setTimeout("$('#warn').fadeOut(500)", 3000);
        }
      }
    })
  }
  //加载运送列表函数
  function load_ys_grab_list() {
    $.ajax({
      url: baseUrl + 'carriage',
      type: 'post',
      data: {
        workNo,
        datagroupCode,
      },
      headers: {
        methodName: "GrabOrdersNo",
        className: "AppCarriage"
      },
      success: function (data) {
        // console.log("android,抢单刷新成功！");
        // debugger
        var list = data.map.obj;
        var html = '';
        var array = new Array();
        if (list) {
          if (list.length < rows) {
            $('#loadMore').text('暂无更多数据');
          } else {
            $('#loadMore').text('加载更多');
          }
          for (var i = 0; i < list.length; i++) {
            var id = isNull(list[i].id);
            var status_code = isNull(list[i].statusCode);
            billNo = isNull(list[i].billNo);
            var createCateView = isNull(list[i].fromDeptName);
            var from_address = isNull(list[i].from_address);
            var from_dept_name = isNull(list[i].carriageAddressName);
            var carriage_class_name = isNull(list[i].carriageClassName);
            var rec_create_time = isNull(list[i].recCreateTime);
            var status_name = isNull(list[i].statusName);
            var execute_user_name = isNull(list[i].recCreatorNo);
            var has_doctor = isNull(list[i].has_doctor);
            var transport_means_class_name = isNull(list[i].transport_means_class_name);
            var urgent = isNull(list[i].urgent);
            var viewDeptName = isNull(list[i].viewDeptName);
            var patient_name = isNull(list[i].recCreatorNo);
            var patient_bed = isNull(list[i].patient_bed);
            var billDesc = isNull(list[i].recCreateTime); //创建时间
            var urgent = isNull(list[i].urgent); //是否加急;
            var carriageClassName = isNull(list[i].carriageClassName);
            var comments = isNull(list[i].comments);
            var tools = isNull(list[i].tools);
            var score = isNull(list[i].score);
            var fromDeptNo = isNull(list[i].fromDeptNo);
            var index = i + 1;
            var carriageAddress = isNull(list[i].carriageAddressNo);
            html += sendTaskList(urgent, billDesc, index, viewDeptName, createCateView, fromDeptNo, status_code, billNo, from_address, from_dept_name, carriage_class_name, rec_create_time, id, status_code, status_name, patient_name, execute_user_name, transport_means_class_name, carriageClassName, comments, tools, score)
          }
        } else {
          $('#loadMore').text('暂无更多数据');
        }
        $('#name').text(localStorage.getItem('name'));
        $('#toAll').html(html);
        $('#pText').hide();
        $('.mui-spinner').hide();
      },
      complete: function (XMLHttpRequest, status) {
        if (status == 'timeout') {
          $('#pText').hide();
          $('.mui-spinner').hide();
          $("#loading").hide();
          $('#warn small').html('连接超时，请检查您的网络是否通畅！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        } else if (status == 'warn') {
          $('#pText').hide();
          $('.mui-spinner').hide();
          $("#loading").hide();
          $('#warn small').html('连接失败，服务运行异常！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        }
      }
    })
  }

  //底部导航按钮点击事件////运送页面
  mui("#navYun").on('tap', 'a.mui-tab-items', function () {
    //debugger
    classS = this.getAttribute('id');
    console.log('classS', classS)
    if (classS == '0') {
      //回退
      var opCode = 'reback',
        arrayAccept = '',
        task_no = '',
        _status_code = '',
        kk = '0';
      $('#toAll div#div-child').each(function (index, element) {
        var status_code = $(this).find('div#checkedDivs').attr('status_code');
        var codeNameSure = $(this).find('div#checkedDivs').attr('name');
        var id = $(this).find('div#checkedDivs').attr('class') + ',';
        task_no = $(this).find('div#checkedDivs').attr('task_no');
        if (codeNameSure == '1') {
          arrayAccept += id;
          _status_code += status_code
          kk = '1';
        }
      })
      if (_status_code == "03") {
        mui.toast('请选择待接单的工单回退')
        return
      }
      if (kk == '0') {
        $('#warn small').html('请选择需要回退的单据!');
        $("#warn").fadeIn(500);
        setTimeout("$('#warn').fadeOut(500)", 3000);
        return;
      }
      Accepted(opCode, arrayAccept, task_no);
    } else if (classS == '1') {
      // 接单
      judgeCao = 'accept';
      var opCode = 'accept',
        arrayAccept = '',
        fromdept_no = '',
        kk = '0';
      $('#toAll div#div-child').each(function (index, element) {
        // debugger
        var status_code = $(this).find('div#checkedDivs').attr('status_code');
        var codeNameSure = $(this).find('div#checkedDivs').attr('name');
        var id = $(this).find('div#checkedDivs').attr('class');
        var fromDeptNoid = $(this).find('div#checkedDivs').attr('fromDept_No');

        if (codeNameSure == '1' && status_code == '02') {

          fromdept_no += fromDeptNoid;
          arrayAccept += id;
          console.log(fromdept_no)
          console.log(arrayAccept)
          kk = '1';
        }
      })
      if (kk == '0') {
        $('#warn small').html('请选择需要接单的单据，或检查单据是否可接单！');
        $("#warn").fadeIn(500);
        setTimeout("$('#warn').fadeOut(500)", 3000);
        return;
      }
      cordova && cordova.plugins.barcodeScanner.scan(
        function (result) {
          var res_text = result.text;
          if (res_text == fromdept_no) {
            judgeAccept(opCode, arrayAccept);
          } else {
            mui.toast("扫码科室与来电科室不一致 !");
            return;
          }
        },
        function (error) {
          mui.toast("扫码失败 !");
        }
      )
    } else if (classS == '2') {
      // 完工
      // debugger
      var arrayAccept = '',
        kk = '0',
        statuArray = new Array();
      judgeCao = 'over';
      $('#toAll div#div-child').each(function (index, element) {
        var status_code = $(this).find('div#checkedDivs').attr('status_code');
        var codeNameSure = $(this).find('div#checkedDivs').attr('name');
        ids = this.getAttribute('taskIds');
        var id = $(this).find('div#checkedDivs').attr('class');
        if (codeNameSure == '1') {
          arrayAccept += id;
          kk = '1';
          statuArray.push(status_code);
        }
      })

      if (kk == '0') {
        $('#warn small').html('请选择需要完工的单据 ！');
        $("#warn").fadeIn(500);
        setTimeout("$('#warn').fadeOut(500)", 3000);
        return;
      }
      if (statuArray.indexOf("03") == -1) {
        $('#warn small').html('请选择待完工的单据完工!');
        $('#warn').fadeIn(500);
        setTimeout("$('#warn').fadeOut(500)", 3000);
        return;
      }

      //完工是否直接完工
      var btnArray = ['取消', '确认'];
      mui.confirm('请确认已完成的具体项目', '提醒', btnArray, function (e) {
        if (e.index == 1) {
          find_child_num(arrayAccept)
        }
      })
    } else if (classS == '4') {
      // 抢单
      load_ys_grab_list();
    } else {
      //刷新
      location.reload();
    }
  })

  // 查找子工单数量函数
  function find_child_num(arrayAccept) {
    $.ajax({
      url: baseUrl + 'carriage',
      type: 'post',
      headers: {
        className: 'AppCarriage',
        methodName: 'queryBitem',
      },
      data: {
        id: arrayAccept
      },
      success: function (data) {
        if (data.respCode == 200) {
          if (data.map.obj.length > 0) {
            mui.toast("您有未完成的子工单 !", { type: 'div' })
          } else {
            main_over_work(arrayAccept)
          }
        } else {
          mui.toast(data.respMsg)
        }
      }
    })
  }

  // 主工单完工
  function main_over_work(id) {
    var carriageAddress_No = $('#blewDiv').find('#zi_li').attr('carriageAddress_No');
    location.href = "./yunsong_sample_scan.html?carriageAddress_No=" + carriageAddress_No + "&carriageAddress_id=" + id
  }
  //子工单运送完工按钮点击事件
  function child_tras(id_zi) {
    var carriageAddress_No = $('#blewDiv').find('#zi_li').attr('carriageAddress_No');
    var carriageAddress_id = $('#blewDiv').find('#zi_li').attr('carriageAddress_id');
    console.log(carriageAddress_id)
    var btnArray_zi = ['取消', '确认'];
    mui.confirm('确定完成此工单？', '提示', btnArray_zi, function (s) {
      if (s.index == 1) {
        location.href = "./yunsong_sample_scan.html?carriageAddress_No=" + carriageAddress_No + "&carriageAddress_id=" + carriageAddress_id
      }
    })
  }

  // 点击抢单
  mui('#toAll').on('tap', '#grab button', function () {
    var _id = this.getAttribute('taskIds');
    grab(_id)
  })
  function grab(id) {
    $.ajax({
      url: baseUrl + 'carriage',
      type: "post",
      headers: {
        className: "AppCarriage",
        methodName: "GrabOrders",
      },
      data: {
        id: id,
        transportUserNo: localStorage.getItem("workNo"),
        transportUserName: localStorage.getItem("name")
      },
      success: function (data) {
        if (data.respCode == "200") {

          mui.toast(data.respMsg)
          setTimeout(function () {
            window.location.reload()
          }, 1000)
        } else {
          mui.toast(data.respMsg)
        }
      }
    })
  }

  $('#myModalss').click(function () {
    $(this).css('display', 'none');
    $('.aboveDiv').css('display', 'none');
    $('.aboveDivss').css('display', 'none');
  })

  //主工单完工函数
  function judgeData(arrayAccept, workNo) {
    var arrayValue = new Array(),
      arrayComplete = new Array(),
      numComplete = 0;
    $.ajax({
      url: baseUrl + 'carriage',
      type: 'post',
      data: {
        billId: arrayAccept,
        billItemId: '',
        totalExecuteName: workName,
        totalExecuteNo: workNo
      },
      headers: {
        methodName: "finishBillNo",
        className: "AppCarriage"
      },
      success: function (data) {
        var billNo = data.map.obj[0].billNo
        location.href = "pic.html?billId=" + billNo + ",className=AppCarriage";

      },
      complete: function (XMLHttpRequest, status) {
        if (status == 'timeout') {
          $("#loading").hide();
          $('#warn small').html('连接超时，请检查您的网络是否通畅！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        } else if (status == 'warn') {
          $("#loading").hide();
          $('#warn small').html('连接失败，服务运行异常！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        }
      }
    })
  }
  // 接单函数
  function judgeAccept(opCode, arrayAccept) {
    $.ajax({
      url: baseUrl + 'carriage',
      type: 'post',
      data: {
        billId: arrayAccept,
        executeUserName: workName,
        executeUserNo: workNo
      },
      headers: {
        "methodName": "executeBillNo ",
        "className": "AppCarriage"
      },
      success: function (data) {

        location.reload();
      },
      complete: function (XMLHttpRequest, status) {
        if (status == 'timeout') {
          $("#loading").hide();
          $('#pTexts').hide();
          $('.mui-spinners').hide();
          $('#warn small').html('连接超时，请检查您的网络是否通畅！');
          $('#warn').fadeIn(500);
          setTimeout("$('#warn').fadeOut(500)", 3000);
        } else if (status == 'warn') {
          $("#loading").hide();
          $('#pTexts').hide();
          $('.mui-spinners').hide();
          $('#warn small').html('连接失败，服务运行异常！');
          $('#warn').fadeIn(500);
          setTimeout("$('#warn').fadeOut(500)", 3000);
        }
      }
    })
  }

  //受理
  mui('#aboveAccept').on('tap', 'li.items', function () {
    // debugger;
    var typecodeJudges = this.getAttribute('typecode');

    if (typecodeJudges == '01') {

      qrcodeAccept();

    } else if (typecodeJudges == '02') {

      $('#myModalsssssss').modal('show');

    } else if (typecodeJudges == '03') {

      var opCode = 'accept',
        arrayAccept = '';
      $('#toAll div#div-child').each(function (index, element) {
        var codeNameSure = $(this).find('div#checkedDivs').attr('name');
        var id = $(this).find('div#checkedDivs').attr('class') + ',';
        if (codeNameSure == '1') {
          arrayAccept += id;
        }
      })

      Accepted(opCode, arrayAccept);
    }
  })

  function qrcodeAccept() {
    cordova.plugins.barcodeScanner.scan(
      function (result) {
        if (result.text != "") {
          scaneAccept(result.text);
        }
      },
      function (error) {
        $('#warn small').html('自回科室失败，请重试！');
        $("#warn").fadeIn(500);
        setTimeout("$('#warn').fadeOut(500)", 3000);
      }
    )
  }

  //resultss
  function scaneAccept(resultss) {
    var codeName = decodeURIComponent(resultss);
    var index = codeName.indexOf(',');
    var indexFina = codeName.indexOf('.');
    var nameScan = codeName.substring(index + 1, indexFina);

    deptAcceptCode = codeName.substring(indexFina + 1, codeName.length);

    var arrayAccept = '',
      opCode = 'accept';
    $('#toAll div#div-child').each(function (index, element) {
      var codeNameSure = $(this).find('div#checkedDivs').attr('name');
      var id = $(this).find('div#checkedDivs').attr('class') + ',';
      if (codeNameSure == '1') {
        arrayAccept += id;
      }
    })

    Accepted(opCode, arrayAccept);
  }

  function funJudge() {
    var arrayAccepts = '';
    back_signature = '';
    workNoss = localStorage.getItem('workNo');
    worKnamess = localStorage.getItem('name');

    $('#toAll div#div-child').each(function (index, element) {
      var status_code = $(this).find('div#checkedDivs').attr('status_code');
      var codeNameSure = $(this).find('div#checkedDivs').attr('name');
      var id = $(this).find('div#checkedDivs').attr('class') + ',';
      if (codeNameSure == '1') {
        arrayAccepts += id;
      }
    })

    backDepartment(arrayAccepts);
  }

  mui('#aboveDiv').on('tap', 'li.items', function () {
    var typecodeJudge = this.getAttribute('typecode');
    back_type = typecodeJudge;
    if (typecodeJudge == '01') {

      qrcodeCordovasss();

    } else if (typecodeJudge == '02') {

      $('#myModalsssssss').modal('show');
      /*$('#warn small').html('签名签收功能暂未开通！');
  $('#warn').fadeIn(500);
  setTimeout("$('#warn').fadeOut(500)", 3000);
  return;*/

    } else if (typecodeJudge == '03') {

      $('.aboveDivWarn').css('display', 'block');
      mui('#spanLi').on('tap', 'span', function () {
        var idTexe = this.getAttribute('id');
        if (idTexe == '0') {
          var arrayAccepts = '';
          back_signature = '';
          workNoss = localStorage.getItem('workNo');
          worKnamess = localStorage.getItem('name');

          $('#toAll div#div-child').each(function (index, element) {
            var status_code = $(this).find('div#checkedDivs').attr('status_code');
            var codeNameSure = $(this).find('div#checkedDivs').attr('name');
            var id = $(this).find('div#checkedDivs').attr('class') + ',';
            if (codeNameSure == '1') {
              arrayAccepts += id;
            }
          })

          backDepartment(arrayAccepts);

        } else {
          $('.aboveDivWarn').css('display', 'none');
        }
      })
    }
  })

  function qrcodeCordovasss() {
    cordova.plugins.barcodeScanner.scan(
      function (result) {
        if (result.text != "") {
          scanedsss(result.text);
        }
      },
      function (error) {
        $('#warn small').html('自回科室失败，请重试！');
        $("#warn").fadeIn(500);
        setTimeout("$('#warn').fadeOut(500)", 3000);
      }
    )
  }

  //resultss
  function scanedsss(resultss) {
    var codeName = decodeURIComponent(resultss);
    var index = codeName.indexOf(',');
    var indexFina = codeName.indexOf('.');
    var nameScan = codeName.substring(index + 1, indexFina);

    workNoss = codeName.substring(0, index);
    deptCodess = codeName.substring(indexFina + 1, codeName.length);

    var zhaunArray = new Array();
    $('#toAll div#div-child').each(function (index, element) {
      var codeName = $(this).find('div#checkedDivs').attr('name');
      var id = $(this).find('div#checkedDivs').attr('class') + ',';
      var status_code = $(this).find('div#checkedDivs').attr('status_code');
      if (codeName == '1') {
        zhaunArray += id;
      }
    });

    departmentScan(zhaunArray, nameScan);

  }

  //扫码及扫码
  function departmentScan(zhaunArray, nameScan) {
    /*alert(zhaunArray);*/
    $.ajax({
      url: baseUrl + 'app_carriageAppController.do?backToDepartmentByScan',
      type: 'post',
      data: {
        taskID: zhaunArray,
        currentUser: workNo,
        currentUserName: workName,
        back_type: back_type,
        back_time: back_time,
        back_confirm_man_account: workNoss,
        back_confirm_man_name: nameScan,
        back_signature: back_signature,
        service_score: service_score,
        deptCode: deptCodess
      },
      success: function (data) {
        if (data.respCode == 200 || data.respCode == '200') {
          judgeEve(zhaunArray);
        } else {
          $('#warn small').html(data.respMsg);
          $("#warn").fadeIn(500);
          setTimeout("$('#warn').fadeOut(500)", 3000);
          return;
        }
      },
      complete: function (XMLHttpRequest, status) {
        if (status == 'timeout') {
          $("#loading").hide();
          $('#warn small').html('连接超时，请检查您的网络是否通畅！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        } else if (status == 'warn') {
          $("#loading").hide();
          $('#warn small').html('连接失败，服务运行异常！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        }
      }
    })
  }

  function judgeEve(zhaunArray) {
    $.ajax({
      url: baseUrl + 'app_carriageAppController.do?queryEvalTypes',
      type: 'post',
      data: {
        taskID: zhaunArray,
        currentUser: workNo,
        currentUserName: workName,
        back_type: back_type,
        back_time: back_time,
        back_confirm_man_account: workNoss,
        back_confirm_man_name: worKnamess,
        back_signature: back_signature,
        service_score: service_score,
        deptCode: deptCodess
      },
      success: function (data) {
        var listdata = data.obj;
        if (data.respCode == 200 || data.respCode == '200') {
          var arraryData = {
            'taskID': zhaunArray,
            'currentUser': workNo,
            'currentUserName': workName,
            'taskType': 'YS'
          }
          var jsonArray = JSON.stringify(arraryData);

          for (var i = 0; i < listdata.length; i++) {
            var typecode = listdata[i].typecode;
            var paramValue1 = listdata[i].paramValue1;
            if (typecode == '01') {
              if (paramValue1 == 'Y') {
                location.href = "evalStar.html?" + encodeURIComponent(jsonArray);
              } else {
                location.reload();
              }
            }
          }
        }
      },
      complete: function (XMLHttpRequest, status) {
        if (status == 'timeout') {
          $("#loading").hide();
          $('#warn small').html('连接超时，请检查您的网络是否通畅！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        } else if (status == 'warn') {
          $("#loading").hide();
          $('#warn small').html('连接失败，服务运行异常！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        }
      }
    })
  }

  //签名
  $(document).on('ready', function () {
    if ($('.js-signature').length) {
      $('.js-signature').jqSignature();
    }
  });

  function clearCanvas() {
    $('.js-signature').eq(0).jqSignature('clearCanvas');
  }

  function saveSignature() {
    $('#signature').empty();
    var dataUrl = $('.js-signature').eq(0).jqSignature('getDataURL');
    var img = $('<img>').attr('src', dataUrl);
    $('#signature').append(img);

    //获取图片
    $("#signature img").each(function (index, element) {
      if (judgeCao == 'over') {
        back_signature = getBase64Image(element);
      } else {
        back_signature_accept = getBase64Image(element);
      }
    })

    var arrayAccepts = '',
      arrayAccept = '';

    $('#toAll div#div-child').each(function (index, element) {
      var status_code = $(this).find('div#checkedDivs').attr('status_code');
      var codeNameSure = $(this).find('div#checkedDivs').attr('name');
      var id = $(this).find('div#checkedDivs').attr('class') + ',';
      //alert(id);
      if (codeNameSure == '1') {
        arrayAccepts += id;
        arrayAccept += id;
      }
    })

    //判断调的接口
    if (judgeCao == 'over') {
      AcceptSignature(arrayAccepts);
    } else {
      var opCode = 'accept';
      Accepted(opCode, arrayAccept);
    }
  }

  $('.js-signature').eq(1).on('jq.signature.changed', function () {
    $('#saveBtn').attr('disabled', false);
  });

  function AcceptSignature(arrayAccepts) {
    $.ajax({
      url: baseUrl + 'app_carriageAppController.do?saveSignatures',
      type: 'post',
      data: {
        picStr: back_signature,
        id: arrayAccepts,
        workNo: workNo,
        back_type: back_type
      },
      success: function (data) {
        if (data.respCode == 200 || data.respCode == '200') {
          judgeEve(arrayAccepts);
        } else {
          $('#warn small').html(data.respMsg);
          $("#warn").fadeIn(500);
          setTimeout("$('#warn').fadeOut(500)", 3000);
          return;
        }
      },
      complete: function (XMLHttpRequest, status) {
        if (status == 'timeout') {
          $("#loading").hide();
          $('#warn small').html('连接超时，请检查您的网络是否通畅！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        } else if (status == 'warn') {
          $("#loading").hide();
          $('#warn small').html('连接失败，服务运行异常！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        }
      }
    })
  }

  //获取图片base64
  function getBase64Image(img) {
    var canvas = document.createElement("canvas");
    var image = new Image();
    image.src = img.src;
    img.crossOrigin = "Anonymous";
    var width;
    var height;
    width = 768;
    height = image.height * 768 / image.width;
    background = 'red';
    canvas.width = width;
    canvas.height = height;
    canvas.background = "#FFFFFF";
    var ctx = canvas.getContext("2d");
    ctx.drawImage(image, 0, 0, width, height);
    var dataURL = canvas.toDataURL("image/JPEG");
    //data:image/jpeg;base64,
    return dataURL.substring(23, dataURL.length);
    // return dataURL.replace("data:image/png;base64,", "");
  };

  $('#myModal').click(function () {
    $(this).css('display', 'none');
    $('.aboveDiv').css('display', 'none');
    $('.aboveDivss').css('display', 'none');
    $('.aboveAccept').css('display', 'none');
  })

  function Accepted(opCode, arrayAccept, task_no) {
    var methodName = ''
    var className = ''
    var param = {}
    var _arrayAccept = arrayAccept.substring(0, arrayAccept.length - 1);
    if (opCode == "reback") {
      methodName = 'withdrawBillNo',
        className = 'AppCarriage',
        param = {
          id: _arrayAccept,
          billNo: task_no,
        }
    }
    $.ajax({
      url: baseUrl + 'carriage',
      type: 'post',
      headers: {
        className: className,
        methodName: methodName
      },
      data: param,
      success: function (data) {
        //console.log(data);
        if (data.respCode == 200 || data.respCode == '200') {
          $('#warn small').html('处理中, 请稍后...');
          $('#warn').fadeIn(500);
          setTimeout("$('#warn').fadeOut(500)", 1500);
          ajaxData();
          //隐藏
          $('.aboveAccept').css('display', 'none');
          $('#myModal').css('display', 'none');
        } else {
          $('#warn small').html(data.respMsg);
          $("#warn").fadeIn(500);
          setTimeout("$('#warn').fadeOut(500)", 3000);
          return;
        }
      },
      complete: function (XMLHttpRequest, status) {
        if (status == 'timeout') {
          $("#loading").hide();
          $('#warn small').html('连接超时，请检查您的网络是否通畅！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        } else if (status == 'warn') {
          $("#loading").hide();
          $('#warn small').html('连接失败，服务运行异常！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        }
      }
    })
  }

  function backDepartment(arrayAccept) {
    $.ajax({
      url: baseUrl + 'app_carriageAppController.do?backToDepartment',
      type: 'post',
      data: {
        taskID: arrayAccept,
        currentUser: workNo,
        currentUserName: workName,
        back_type: back_type,
        back_time: back_time,
        back_confirm_man_account: workNoss,
        back_confirm_man_name: worKnamess,
        back_signature: back_signature,
        service_score: service_score,
        deptCode: deptCode
      },
      success: function (data) {
        if (data.respCode == 200 || data.respCode == '200') {
          $('#warn small').html('处理中, 请稍后...');
          $('#warn').fadeIn(500);
          setTimeout("$('#warn').fadeOut(500)", 3000);
          location.reload();
        } else {
          $('#warn small').html(data.respMsg);
          $("#warn").fadeIn(500);
          setTimeout("$('#warn').fadeOut(500)", 3000);
          return;
        }
      },
      complete: function (XMLHttpRequest, status) {
        if (status == 'timeout') {
          $("#loading").hide();
          $('#warn small').html('连接超时，请检查您的网络是否通畅！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        } else if (status == 'warn') {
          $("#loading").hide();
          $('#warn small').html('连接失败，服务运行异常！');
          $('#warn').show();
          setTimeout("$('#warn').hide()", 3000);
        }
      }
    })
  }

  //确定,取消
  mui('.listUl').on('tap', 'p.pButton button', function () {
    var idss = $(this).attr('name');
    if ($(this).attr('id') == '0') {
      var opCode = 'finish';
      if (scanFinish) {
        cordova.plugins.barcodeScanner.scan(
          function (result) {
            if (result.text != "")
              funSureCancel(idss, opCode, result.text);
          },
          function (error) {
            $('#warn small').html('获取二维码失败');
            $("#warn").fadeIn(500);
            setTimeout("$('#warn').fadeOut(500)", 3000);
          }
        )
      } else {
        funSureCancel(idss, opCode, "");
      }
    } else {
      var opCode = 'cancel';
      funSureCancel(idss, opCode, "");
    }

  })
  // 接单
  function funSureCancel(idss, opCode, deptNum) {
    $.ajax({
      url: baseUrl + 'carriage',
      type: 'post',
      data: {
        id: idss,
        billId: ids,
        opCode: opCode,
        currentUser: workNo,
        acceptName: workName,
        completeType: 'APP',
        deptNum: deptNum
      },
      headers: {
        "methodName": "acceptBillNo",
        "className": "AppCarriage"
      },
      success: function (data) {
        if (data.respCode == '200' || data.respCode == 200) {
          $('#warnss small').html(data.respMsg);
          $('#warnss').fadeIn(500);
          setTimeout("$('#warnss').fadeOut(500)", 2500)
          ajaxData();
          listPJ();
          offCanvasWrapper.offCanvas('show');
        } else {
          $('#warnss small').html(data.respMsg);
          $('#warnss').fadeIn(500);
          setTimeout("$('#warnss').fadeOut(500)", 3000);
          return;
        }
      },
      complete: function (XMLHttpRequest, status) {
        if (status == 'timeout') {
          $("#loading").hide();
          $('#warn small').html('连接超时，请检查您的网络是否通畅！');
          $('#warn').fadeIn(500);
          setTimeout("$('#warn').fadeOut(500)", 3000);
        } else if (status == 'warn') {
          $("#loading").hide();
          $('#warn small').html('连接失败，服务运行异常！');
          $('#warn').fadeIn(500);
          setTimeout("$('#warn').fadeOut(500)", 3000);
        }
      }
    })
  }

  //运送
  mui('#toAll').on('tap', 'div#checkedDivs', function () {
    var nameUe = $(this).attr('name');
    if (nameUe == '0') {
      $(this).parent().find('div#checkedDivsg').html('<span class="glyphicon glyphicon-ok" style="color:#007AFF;"></span>');
      $(this).attr('name', '1').parent().parent().parent().parent().siblings('div#div-child').find('div#checkedDivs').attr('name', '0');
      $(this).parent().parent().parent().parent().siblings('div#div-child').find('div#checkedDivsg').html('');

      // $(this).parent().parent().parent().parent().find('div.panel-bodys');
    } else {
      $(this).parent().find('div#checkedDivsg').html('');
      $(this).attr('name', '0');
      // $(this).parent().parent().parent().parent().find('div.panel-bodys');
    }
  })

  mui('#toAll').on('tap', 'div#rowss1', function () {
    $('#listUl').html('');
    clearTimeout(timer);
    var valuessT = $(this).siblings('div').find('div#checkedDivs').attr('name');
    ids = this.getAttribute('taskIds');
    patient_name = $(this).attr('patient_name');
    $(this).parent().parent().parent().css('background', 'darkgray').siblings('div#div-child').css('background', '');;
    $(this).parent().parent().parent().find('div#panel-heading').css('background', 'darkgray');
    $(this).parent().parent().parent().siblings('div').find('div#panel-heading').css('background', '');
    //打开菜单
    $('#pTexts').show();
    $('.mui-spinners').show();
    offCanvasWrapper.offCanvas('show');
    timer = setTimeout('listPJ()', 500);
  })

  mui('.listUl').on('tap', 'li.lisBlew', function () {
    var name = $(this).attr('name');
    $(this).parent().find('span#blewDiv').toggle();
    if (name == '0') {
      $(this).find('span').attr('class', 'mui-icon mui-icon-arrowup');
      $(this).attr('name', '1');
    } else {
      $(this).find('span').attr('class', 'mui-icon mui-icon-arrowdown');
      $(this).attr('name', '0');
    }
  })

  //关闭菜单
  var offCanvasWrapper = mui('#offCanvasWrapper');
  document.getElementById('offCanvasHide').addEventListener('tap', function () {
    offCanvasWrapper.offCanvas('close');
  });
  var contentMainss = document.getElementById("contentMain");
  var qrcodeParents = document.getElementById("qrcodeParent");
  var qrcode = document.getElementById("qrcode");
  var myModals = document.getElementById("myModal");

  qrcode.addEventListener('tap', function () {
    $('#contentMain').removeClass('blur');
    qrcodeParents.style.display = 'none';
    myModals.style.display = 'none';
  }, true);

  //禁用ios平台原生侧滑关闭页面
  if (mui.os.plus && mui.os.ios) {
    mui.plusReady(function () {
      plus.webview.currentWebview().setStyle({
        'popGesture': 'none'
      });
    });
  }

  var elem = document.querySelector('body');
  elem.addEventListener("dragend", function () {
    /* alert('加载中...');*/
  });

  //生成二维码
  $(function () {
    //更详细的配置
    $('#qrcode').qrcode({
      text: encodeURIComponent(workNo + ',' + name + '.' + deptCode),
      width: 250,
      height: 250,
      background: "#FFFFFF",
      foreground: "black"
    });
  })

  //显示运送、陪检
  mui('#sliderSegmentedControl').on('tap', 'div.center', function () {
    var idText = this.getAttribute('name');
    if (idText == '0') {
      location.href = "sendList.html";
    } else if (idText == '1') {
      location.href = "yunsong.html";
    }
  })

  $('#back').click(function () {
    location.href = "../../menu.html";
  })

  document.getElementById("offCanvasWrapper").addEventListener('shown', function (e) {
    $('#offCanvasSide').css('visibility', 'visible');
    moveTogether = true;
  });

  document.getElementById("offCanvasWrapper").addEventListener('hidden', function (e) {
    $('#offCanvasSide').css('visibility', 'hidden');
    moveTogether = false;
  });
</script>

</html>