<!doctype html>
<html class="no-js">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<meta name="renderer" content="webkit">
		<meta http-equiv="Cache-Control" content="no-siteapp" />
		<meta name="format-detection" content="telephone=no" />
		<link rel="stylesheet" href="../reference/mui/css/mui.min.css">
		<link rel="stylesheet" href="../reference/css/common.css" />
		<link rel="stylesheet" href="../reference/mui/css/mui.picker.min.css">
		<link rel="stylesheet" href="css/tcj-font.css" />
	</head>
	<STYLE TYPE="text/css">
		body,
		html {
			height: 100%;
			background: #F7F7F7;
		}
		
		.row-content {
			height: 40px;
			line-height: 40px;
			padding: 0 15px;
			border-bottom: 1px solid #EEEEEE;
			font-size: 14px;
			color: #666666;
			background: #ffffff;
		}
		
		.row-content1 {
			height: 30px;
			line-height: 30px;
			padding: 0 15px;
			font-size: 16px;
			color: #666666;
			background: #ffffff;
		}
		
		.row-right {
			text-align: right;
			color: #333333;
		}
		
		.new-icon-color {
			color: #aaa;
		}
		
		.new-row-tcj {
			height: 60px;
			line-height: 60px;
		}
		
		.wuzi-list-title {
			background: #fff;
			display: flex;
			height: 40px;
			line-height: 40px;
			border-bottom: 1px solid #ddd;
		}
		
		.shugang {
			display: inline-block;
			width: 5px;
			height: 20px;
			background: #2aabd2;
			margin: 10px 18px;
			border-radius: 15px;
		}
		
		.shugang-text {
			color: #444;
			font-weight: bold;
			font-size: 16px;
		}
		
		.aa {
			width: 100%;
			height: 94px;
			border-bottom: 1px solid #eee;
			padding: 10px;
		}
		
		.bb {
			width: 64px;
			height: 64px;
			display: inline-block;
			float: left;
		}
		
		.bb img {
			width: 64px;
			height: 64px;
		}
		
		.cc {
			width: calc(100% - 64px);
			height: 85px;
			display: inline-block;
			float: left;
			padding-left: 15px;
		}
		
		.dd {
			/*font-weight: bold;*/
			font-size: 14px;
			height: 20px;
			/*line-height: 37px;*/
			color: #333;
		}
		
		.ee {
			/*height: 27px;*/
			/*line-height: 27px;*/
			font-size: 12px;
			color: #777;
		}
		
		.ff {
			height: 30px;
			line-height: 30px;
		}
		
		.price {
			font-size: 16px;
			font-weight: bold;
			color: #ffa740;
		}
		
		.price span {
			font-size: 13px;
			font-weight: 400;
			color: #a5a5a5;
		}
		
		.btn-minus span {
			font-size: 35px;
			color: #bbb;
		}
		
		.btn-plus span {
			font-size: 35px;
			color: #55cbeb;
		}
		
		.selection-active {
			color: #55cbeb;
		}
		
		.add {
			position: absolute;
			/*bottom: 170px;*/
			right: 30px;
			width: 45px;
			height: 45px;
			line-height: 45px;
			background: #5ac2ee;
			color: #fff;
			text-align: center;
			opacity: 0.9;
			font-size: 15px;
			border-radius: 50%;
			box-shadow: 0px 0px 10px 5px #5ac2ee;
			z-index: 90;
		}
	</STYLE>

	<body>
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title" id="beforeTitle">计划申请修改</h1>
			<button id="back" class="mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left">
        <span class="mui-icon mui-icon-left-nav"></span>
        返回
       </button>
			<button id="suretijiao" class="mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-right" style="margin-right: 0;">
提交
       </button>

		</header>

		<div id="warn" class="warn" hidden>
			<small></small>
		</div>

		<div id="loading" class="loading1" hidden>
			<div class="loading2">
				<span class="mui-spinner" style="width:80px;height:80px;"></span>
			</div>
		</div>

		<div class="mui-content">
			<div class="mui-row row-content">

				<div class="mui-col-sm-5 mui-col-xs-5">

					<span class="mui-icon iconfont  icon-apply-person new-icon-color"></span> 申请人：
				</div>
				<div class="mui-col-sm-7 mui-col-xs-7 row-right">
					<input id="userName" type="text" style="width:100%;border:0;outline:none;font-size:14px;padding:0px;text-align:right;margin-bottom:0;height:21px;" placeholder="用户名" readonly="readonly">
				</div>
			</div>
			<div class="mui-row row-content">

				<div class="mui-col-sm-5 mui-col-xs-5">
					<span class="mui-icon  iconfont icon-apply-keshi new-icon-color"></span> 申请科室：
				</div>
				<div class="mui-col-sm-7 mui-col-xs-7 row-right applyDept">
					<input type="text" id="applyDept" style="width: 80%;border:0;outline:none;font-size:14px;padding:0px;text-align:right;margin-bottom:0;height:21px;" placeholder="申请科室" readonly="readonly" />
					<!--<span class="mui-icon iconfont icon-youjiantou" style="color:#55cbeb;font-weight: bold;"></span>-->
				</div>
			</div>
			<div class="mui-row row-content">

				<div class="mui-col-sm-5 mui-col-xs-5">
					<span class="mui-icon   iconfont   icon-jiaohuo-date new-icon-color"></span> 申请时间：
				</div>
				<div class="mui-col-sm-7 mui-col-xs-7 row-right applyTime">
					<input type="text" id="applyTime" style="width: 80%;border:0;outline:none;font-size:14px;padding:0px;text-align:right;margin-bottom:0;height:21px;" placeholder="请选择申请时间" readonly="readonly" />
					<span class="mui-icon iconfont icon-youjiantou" style="color:#55cbeb;font-weight: bold;"></span>
				</div>
			</div>

			<!--<div class="mui-row row-content">

				<div class="mui-col-sm-5 mui-col-xs-5">

					<span class="mui-icon   iconfont icon-dai-tijiao new-icon-color"></span> 交货期：
				</div>
				<div class="mui-col-sm-7 mui-col-xs-7 row-right askGive">
					<input type="text" id="askGive" style="width: 80%;border:0;outline:none;font-size:14px;padding:0px;text-align:right;margin-bottom:0;height:21px;" placeholder="请选择交货日期" readonly="readonly" />
					<span class="mui-icon iconfont icon-youjiantou" style="color:#55cbeb;font-weight: bold;"></span>
				</div>
			</div>-->

			<div class="mui-row row-content new-row-tcj">

				<div class="mui-col-sm-5 mui-col-xs-5" style="	padding-left: 20px;color: #AAAAAA;font-size: 12px;">
					备注:
				</div>
				<div class="mui-col-sm-7 mui-col-xs-7 row-right">
					<input id="desc" type="text" style="padding: 0px;border: 0px;outline: none;text-align: right;margin-bottom:0;height: 20px;line-height: 20px;" placeholder="请输入备注" />
				</div>
			</div>
		</div>
		<div class="wuzi-list wuzi-list-wocao" style="margin-bottom: 5px;">
			<div class="wuzi-list-content" style="margin: 10px  5px;">
				<div class="wuzi-list-title">
					<span class="shugang"></span>
					<span class="shugang-text">常用物资列表</span>
				</div>
				<div style="background: #fff;" class="wuzi-list-new">

					<!--<div class="aa">
						<div class="bb"><img src="img/2.png"></div>
						<div class="cc">
							<div class="dd word-omit">日你哥现任把那边</div>
							<div class="ee">T5 22W</div>
							<div class="ff mui-row">
								<div class="mui-col-xs-6 price">
									<span>剩余&nbsp;&nbsp;</span>1
								</div>
								<div class="mui-col-xs-2 right btn-minus" style="padding-top:2px;">
									<span class="mui-icon  iconfont  icon-jian"></span>
								</div>
								<div class="mui-col-xs-2 center num-div" style="padding-top:2px;">0</div>
								<div class="mui-col-xs-2 btn-plus" style="padding-top:2px;">
									<span class="mui-icon  iconfont  icon-jia1"></span>
								</div>
							</div>
						</div>
					</div>-->
				</div>

			</div>

		</div>

	</body>
	<script src="../reference/mui/js/mui.min.js" type="text/javascript"></script>
	<script src="../reference/js/jquery-2.1.4.js" type="text/javascript"></script>
	<script src="../reference/js/common.js" type="text/javascript"></script>
	<script src="../reference/mui/js/mui.picker.min.js" type="text/javascript"></script>
	<script src="../../cordova.js" type="text/javascript"></script>
	<script type="text/javascript">
		var baseUrl = localStorage.getItem("url");
		var workNo = localStorage.getItem('workNo');
		var deptNum = localStorage.getItem('deptCode');
		var deptName = localStorage.getItem("deptName");
		var name = localStorage.getItem("name");
		var setArry = [];
		var beforeLis22 = localStorage.getItem("change-info");
		var beforeList = JSON.parse(beforeLis22);
		console.log("列表部分");
		console.log(beforeList);
		var setArry1 = JSON.parse(beforeList.matData);

		getSeilfInfo();
		//判断缓存信息

		function getSeilfInfo() {
			if(beforeList != null) {
				loadView();
			} else {
				showMsg("加载数据出错！");
			}

		}

		function loadView() {

			var list = setArry1;
			console.log(list)
			for(var i = 0; i < list.length; i++) {

				var aa = {
					"image": list[i].fileUrl,
					"matModel": list[i].matModel,
					"matName": list[i].matName,
					"matNum": list[i].matNum,
					"storageNum": list[i].storageNum,
					"applyNum": list[i].applyNum
				}
				setArry.push(aa)
			}
			$("#userName").val(beforeList.applyStaffName);
			$("#applyTime").val(beforeList.applyDate);
			$("#applyDept").val(list[0].deptName);
			$("#desc").val(list[0].remark)
			loadViewSelf();

		}

		function loadViewSelf() {
			var com = "before";
			var tasklist = "";
			for(var i = 0; i < setArry.length; i++) {
				tasklist += createView(setArry[i].image, setArry[i].matModel, setArry[i].matName, setArry[i].matNum, setArry[i].storageNum, setArry[i].applyNum, com);
			}
			$(".wuzi-list-new").html(tasklist);

		}

		function createView(image, matModel, matName, matNum, storageNum, applyNum, com) {
			var jsonObj = {
				"image": image,
				"matModel": matModel,
				"matName": matName,
				"matNum": matNum,
				"storageNum": storageNum,
				"applyNum": applyNum,
				"com": com
			}
			var jsonString = JSON.stringify(jsonObj)
			''
			var html = "";
			html += '<div  id=\'' + jsonString + '\' class="aa">';
			if(image == null)
				html += '<div class="bb"><img src="img/1.png"></div>';
			else
				html += '<div class="bb"><img src="' + baseUrl + image + '"></div>';
			html += '<div class="cc">';
			html += '	<div class="dd word-omit">' + matName + '</div>';
			html += '	<div class="ee">型号：' + matModel + '</div>';
			html += '	<div class="ff mui-row">';
			html += '	<div class="mui-col-xs-6 price">';
			html += '		<span>剩余&nbsp;&nbsp;</span>' + storageNum + '</div>';
			html += '	<div class="mui-col-xs-2 right btn-minus" style="padding-top:2px;">';
			html += '	<span class="mui-icon  iconfont  icon-jian"></span>';
			html += '	</div>';
			html += '	<div class="mui-col-xs-2 center num-div" style="padding-top:2px;">' + applyNum + '</div>';
			html += '	<div class="mui-col-xs-2 btn-plus" style="padding-top:2px;">';
			html += '	<span class="mui-icon  iconfont  icon-jia1"></span>';
			html += '	</div>';
			html += '</div>';
			html += '</div>';
			html += '</div>';

			return html;

		}

		/*
		 * 列表部分按钮的加、减
		 * */
		//增加
		mui("body").on('tap', '.icon-jia1', function() {

			var _this_parent = this.parentNode.parentNode.parentNode.parentNode;
			var aaa = JSON.parse(_this_parent.id).com;
			//			console.log(aaa)
			var numSelf = JSON.parse(_this_parent.id).matNum;
			var maxNum = JSON.parse(_this_parent.id).storageNum;
			//			console.log(_this_parent.id);
			//			console.log(_this_parent.children[1].children[2].children[2].innerHTML);
			for(var i = 0; i < setArry.length; i++) {

				if(setArry[i].matNum == numSelf) {
					setArry[i].applyNum += 1;
					//						if(setArry[i].applyNum < maxNum) {
					//							setArry[i].applyNum += 1;
					//						} else {
					//							showMsg("剩余物品不足！")
					//						}
					_this_parent.children[1].children[2].children[2].innerHTML = setArry[i].applyNum;
					break;
				}
			}
			//				console.log(setArry)

		}); //减少
		mui("body").on('tap', '.icon-jian', function() {
			var _this_parent = this.parentNode.parentNode.parentNode.parentNode;
			var aaa = JSON.parse(_this_parent.id).com;
			//			console.log(aaa);
			var numSelf = JSON.parse(_this_parent.id).matNum;
			for(var i = 0; i < setArry.length; i++) {
				if(setArry[i].matNum == numSelf) {
					if(setArry[i].applyNum >= 1) {
						setArry[i].applyNum -= 1;
					} else {
						setArry[i].applyNum = 0;
					}

					_this_parent.children[1].children[2].children[2].innerHTML = setArry[i].applyNum;
					break;
				}
			}
			console.log(setArry)

		});

		//确认提交
		mui("body").on("tap", "#suretijiao", function() {

			//			if($("#askGive").val() == "") {
			//				showMsg("请选择交货时间！");
			//				return;
			//			}
			var aaaaaa = [];
			for(var i = 0; i < setArry.length; i++) {
				var cc = {
					"image": setArry[i].image,
					"matModel": setArry[i].matModel,
					"matName": setArry[i].matName,
					"matNum": setArry[i].matNum,
					"storageNum": setArry[i].storageNum,
					"applyNum": setArry[i].applyNum
				}
				if(Number(setArry[i].applyNum) > 0) {
					aaaaaa.push(cc);
				}

			}

			console.log(aaaaaa);
			if(aaaaaa.length == 0) {
				showMsg("请选择物资！");
				return;
			}

			$('#loading').show();
			$.ajax({
				//				url: "../json/new-apply.json",
				//				type: "get",
				url: baseUrl + "app_DeliveryController.do?modifyMatApply",
				type: "post",
				data: {
					matApplyBillNo: beforeList.matApplyBillNo,
					matInfo: JSON.stringify(aaaaaa)
				},
				success: function(data) {

					var data = eval("(" + data + ")");
					console.log(data);
					if(data.respCode == "200") {
						removeSet();
						setTimeout('location.href="plan-apply.html";', 2000);
					} else {
						$('#loading').hide();
						showMsg(data.respMsg);

					}

				}
			});

		});
		//选择申请时间
		//		mui("body").on("tap", ".applyTime", function() {
		//			var options = {
		//				"type": "datetime",
		//				endDate: new Date() //设置结束日期 
		//			};
		//			var applyTimepickerDate = new mui.DtPicker(options);
		//			applyTimepickerDate.show(function(rs) {
		//				$("#applyTime").val(rs.text);
		//			});
		//		});

		//选择交货日期
		mui("body").on("tap", ".askGive", function() {
			var options = {
				"type": "date",
				beginDate: new Date() //设置结束日期 
			};
			var askGivepickerDate = new mui.DtPicker(options);
			askGivepickerDate.show(function(rs) {
				$("#askGive").val(rs.text);
			});
		});

		mui("body").on("tap", "#back", function() {
			removeSet();
			location.href = "plan-apply.html";
		});
		document.addEventListener("deviceready", onDeviceReady, false);

		function onDeviceReady() {
			document.addEventListener("backbutton", onBackKeyDown, false);
		}

		function onBackKeyDown() {
			removeSet();
			location.href = "plan-apply.html";
		}
		/*底部页面的切换*/
		mui("body").on("tap", ".my-plan", function() {
			removeSet();
			location.href = "plan-apply.html";
		});
		mui("body").on("tap", ".new-project", function() {
			removeSet();
			location.href = "new-apply.html";
		});
		mui("body").on("tap", ".dai-tijiao", function() {
			removeSet();
			location.href = "plan-submit.html";
		})

		function removeSet() {

			localStorage.removeItem("change-info");
		}
	</script>

</html>