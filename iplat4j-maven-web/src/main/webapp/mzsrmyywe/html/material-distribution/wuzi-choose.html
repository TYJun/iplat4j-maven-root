<!DOCTYPE html>
<html class="no-js">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="renderer" content="webkit" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="format-detection" content="telephone=no" />
    <link rel="stylesheet" href="../reference/mui/css/mui.min.css" />
    <link rel="stylesheet" href="../reference/css/common.css" />
    <link rel="stylesheet" href="../reference/mui/css/mui.picker.min.css" />
    <link rel="stylesheet" href="css/tcj-font.css" />
</head>
<style type="text/css">
    body,
    html {
        height: 100%;
        background: #f7f7f7;
    }
    
    .row-content {
        height: 40px;
        line-height: 40px;
        padding: 0 15px;
        border-bottom: 1px solid #eeeeee;
        font-size: 14px;
        color: #666666;
        background: #ffffff;
    }
    
    .row-content1 {
        height: 30px;
        line-height: 30px;
        padding: 0 15px;
        font-size: 16px;
        color: #666666;
        background: #ffffff;
    }
    
    .row-right {
        text-align: right;
        color: #333333;
    }
    
    .new-icon-color {
        color: #aaa;
    }
    
    .new-row-tcj {
        height: 60px;
        line-height: 60px;
        display: flex;
        justify-content: space-between;
        font-size: 14px;
    }
    
    .quxiao {
        height: 32px;
        width: 21%;
        background: #fafafa;
        text-align: center;
        line-height: 32px;
        border-radius: 15px;
        margin-top: 14px;
        color: #333333;
    }
    
    .queding {
        height: 32px;
        width: 21%;
        background: #41bde2;
        text-align: center;
        line-height: 32px;
        border-radius: 15px;
        margin-top: 14px;
        color: #fff;
    }
    
    .wuzi-list-title {
        background: #55c8eb;
        /* display: flex; */
        height: 40px;
        line-height: 40px;
        border-bottom: 1px solid #ddd;
        padding-left: 10px;
        color: #fff;
        letter-spacing: 1px;
        font-size: 12px;
    }
    
    .shugang {
        display: inline-block;
        width: 5px;
        height: 20px;
        background: #2aabd2;
        margin: 10px 18px;
        border-radius: 15px;
    }
    
    .shugang-text {
        color: #444;
        font-weight: bold;
        font-size: 16px;
    }
    
    .aa {
        width: 100%;
        height: 94px;
        border-bottom: 1px solid #eee;
        padding: 10px;
    }
    
    .bb {
        width: 64px;
        height: 64px;
        display: inline-block;
        float: left;
    }
    
    .bb img {
        width: 64px;
        height: 64px;
    }
    
    .cc {
        width: 100%;
        /* width: calc(100% - 64px); */
        height: 85px;
        display: inline-block;
        float: left;
        padding-left: 15px;
    }
    
    .dd {
        /*font-weight: bold;*/
        font-size: 14px;
        height: 20px;
        /*line-height: 37px;*/
        color: #333;
    }
    
    .ee {
        /*height: 27px;*/
        /*line-height: 27px;*/
        font-size: 12px;
        color: #777;
    }
    
    .ff {
        height: 30px;
        line-height: 30px;
    }
    
    .price {
        font-size: 16px;
        font-weight: bold;
        color: #ffa740;
    }
    
    .price span {
        font-size: 13px;
        font-weight: 400;
        color: #a5a5a5;
    }
    
    .btn-minus span {
        font-size: 30px;
        color: #bbb;
    }
    
    .btn-plus span {
        font-size: 30px;
        color: #55cbeb;
    }
    
    .selection-active {
        color: #55cbeb;
    }
</style>

<body>
    <div id="choose" style="display: none">
        <header class="mui-bar mui-bar-nav">
            <h1 class="mui-title" id="chooseTitle">物资名称</h1>
            <button onclick="changeShow()" class="mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left">
          <span class="mui-icon mui-icon-left-nav"></span>
          返回
        </button>
        </header>

        <div class="mui-content" style="">
            <div class="mui-row row-content">
                <div class="mui-col-sm-12 mui-col-xs-12">物资名称：</div>
            </div>
        </div>
    </div>

    <div id="before">
        <header class="mui-bar mui-bar-nav">
            <h1 class="mui-title">物资选择</h1>
            <button id="back" class="mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left">
          <span class="mui-icon mui-icon-left-nav"></span>
          返回
        </button>
            <button id="suretijiao" class="mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-right" style="margin-right: 0">
          提交
        </button>
        </header>

        <div id="warn" class="warn" hidden>
            <small></small>
        </div>

        <div id="loading" class="loading1" hidden>
            <div class="loading2">
                <span class="mui-spinner" style="width: 80px; height: 80px"></span>
            </div>
        </div>

        <div class="mui-content" style="">
            <div class="mui-row row-content">
                <div class="mui-col-sm-5 mui-col-xs-5">
                    <span class="mui-icon iconfont icon-apply-person new-icon-color"></span> 物资名称：
                </div>
                <div class="mui-col-sm-7 mui-col-xs-7 row-right wuziName">
                    <input type="text" id="wuziName" style="
                width: 80%;
                border: 0;
                outline: none;
                font-size: 14px;
                padding: 0px;
                text-align: right;
                margin-bottom: 0;
                height: 21px;
              " placeholder="请输入物资名称" onkeyup="this.value=this.value.replace(/^ +| +$/g,'')" />
                    <span class="mui-icon iconfont icon-youjiantou" style="color: #55cbeb; font-weight: bold"></span>
                </div>
            </div>
            <!-- <div class="mui-row row-content">
                <div class="mui-col-sm-5 mui-col-xs-5">
                    <span class="mui-icon iconfont icon-apply-keshi new-icon-color"></span> 型号：
                </div>
                <div class="mui-col-sm-7 mui-col-xs-7 row-right">
                    <input type="text" id="xinghao" style="
                width: 80%;
                border: 0;
                outline: none;
                font-size: 14px;
                padding: 0px;
                text-align: right;
                margin-bottom: 0;
                height: 21px;
              " placeholder="请输入型号" onkeyup="this.value=this.value.replace(/^ +| +$/g,'')" />
                    <span class="mui-icon iconfont icon-youjiantou" style="color: #55cbeb; font-weight: bold"></span>
                </div>
            </div> -->
            <div class="mui-row row-content">
                <div class="mui-col-sm-5 mui-col-xs-5">
                    <span class="mui-icon iconfont icon-jiaohuo-date new-icon-color"></span> 规格：
                </div>
                <div class="mui-col-sm-7 mui-col-xs-7 row-right">
                    <input type="text" id="guige" style="
                width: 80%;
                border: 0;
                outline: none;
                font-size: 14px;
                padding: 0px;
                text-align: right;
                margin-bottom: 0;
                height: 21px;
              " placeholder="请输入规格" onkeyup="this.value=this.value.replace(/^ +| +$/g,'')" />
                    <span class="mui-icon iconfont icon-youjiantou" style="color: #55cbeb; font-weight: bold"></span>
                </div>
            </div>

            <div class="mui-row row-content new-row-tcj">
                <div class="quxiao">取消</div>
                <div class="queding">查询</div>
            </div>
        </div>
        <div class="wuzi-list">
            <div class="wuzi-list-content" style="margin: 10px 5px">
                <div class="wuzi-list-title">
                    物资信息提示：物资名称/规格/单位/库存量
                    <!--<span class="shugang"></span>
					<span class="shugang-text">日你二大爷</span>-->
                </div>
                <div style="background: #fff" class="wuzi-list-new">
                    <!--
						<div class="aa">
							<div class="bb"><img src="img/2.png"></div>
							<div class="cc">
								<div class="dd word-omit">日你哥现任把那边</div>
								<div class="ee">T5 22W</div>
								<div class="ff mui-row">
									<div class="mui-col-xs-6 price">
										<span>剩余&nbsp;&nbsp;</span>1
									</div>
									<div class="mui-col-xs-2 right btn-minus" style="padding-top:2px;">
										<span class="mui-icon  iconfont  icon-jian"></span>
									</div>
									<div class="mui-col-xs-2 center num-div" style="padding-top:2px;">0</div>
									<div class="mui-col-xs-2 btn-plus" style="padding-top:2px;">
										<span class="mui-icon  iconfont  icon-jia1"></span>
									</div>
								</div>
							</div>
						</div>-->
                </div>
            </div>
        </div>
    </div>
</body>
<script src="../reference/mui/js/mui.min.js" type="text/javascript"></script>
<script src="../reference/js/jquery-2.1.4.js" type="text/javascript"></script>
<script src="../reference/js/common.js" type="text/javascript"></script>
<script src="../reference/mui/js/mui.picker.min.js" type="text/javascript"></script>
<!--<script src="../../cordova.js" type="text/javascript"></script>-->
<script src="js/$ajax.js" type="text/javascript"></script>
<script type="text/javascript">
    var baseUrl = localStorage.getItem("url");
    var workNo = localStorage.getItem("workNo");
    var deptNum = localStorage.getItem("deptCode");
    var deptName = localStorage.getItem("deptName");
    var name = localStorage.getItem("name");
    var jsonString = localStorage.getItem("wuzi-choose-before");
    var jsonObj = JSON.parse(jsonString);
    var wuziChooseString = localStorage.getItem("wuzi-choose");
    var wuziChooseObj = JSON.parse(wuziChooseString);
    //		console.log(wuziChooseObj)
    var setArry = [];
    loadViewList();

    function loadViewList() {
        var prames = {
            AppMatName: $("#wuziName").val(), //物资名称
            AppMatModel: $("#xinghao").val(), //物资型号
            AppMatSpec: $("#guige").val(), //物资型号
        };
        prames = JSON.stringify(prames);
        $ajax("queryAppMat", "MDPSAPP", prames, (res) => {
            // console.log(res.blocks.result.rows);
            var list = res.blocks.result.rows;
            list.map((item) => {
                setArry.push({
                    image: null,
                    matSpec: item.matSpec,
                    matName: item.matName,
                    matNum: item.matNum,
                    matTypeName: item.matTypeName,
                    storageNum: item.zongNum,
                    unitName: item.unitName,
                    applyNum: 0,
                    matModel: item.matModel,
                    unit: item.unit,
                });
            });
            // console.log(setArry);
            loadViewSelf();
        });
    }

    function loadViewSelf() {
        var tasklist = "";
        for (var i = 0; i < setArry.length; i++) {
            tasklist += createView(
                setArry[i].image,
                setArry[i].matSpec,
                setArry[i].matName,
                setArry[i].matNum,
                setArry[i].storageNum,
                setArry[i].unitName,
                setArry[i].applyNum
            );
        }
        $(".wuzi-list-new").html(tasklist);
    }

    function createView(
        image,
        matSpec,
        matName,
        matNum,
        storageNum,
        unitName,
        applyNum
    ) {
        var jsonObj = {
            image: image,
            matSpec: matSpec,
            matName: matName,
            matNum: matNum,
            storageNum: storageNum,
            unitName: unitName,
            applyNum: applyNum,
        };
        var jsonString = JSON.stringify(jsonObj);
        ("");
        var html = "";
        html += "<div  id='" + jsonString + '\' class="aa">';
        // if (image == null) html += '<div class="bb"><img src=""></div>';
        // else html += '<div class="bb"><img src="' + baseUrl + image + '"></div>';

        html += '<div class="cc">';
        html += '	<div class="dd word-omit">' + matName + "</div>";
        html += '	<div class="ee">规格：' + matSpec + "</div>";
        html += '	<div class="ff mui-row">';
        html += '	<div class="mui-col-xs-5 price">';
        html += "		<span style='font-size:16px'>选择数量&nbsp;&nbsp;</span></div>";
        html +=
            '	<div class="mui-col-xs-2 right btn-minus" style="padding-top:2px;">';
        html += '	<span class="mui-icon  iconfont  icon-jian"></span>';
        html += "	</div>";
        //			html += '	<div class="mui-col-xs-2 center num-div" style="padding-top:2px;">' + applyNum + '</div>';
        html +=
            '	<div class="mui-col-xs-3 center num-div" style="padding-top:2px;">';
        html +=
            "	<input  id='" +
            jsonString +
            '\' class="numInput"  type="number"  style="width: 45%;border:0;outline:none;font-size:14px;padding:0px;text-align:center;margin-bottom:0;height:21px;"  placeholder="0"  value="' +
            applyNum +
            '" />';
        html += "</div>";
        html += '	<div class="mui-col-xs-2 btn-plus" style="padding-top:2px;">';
        html += '	<span class="mui-icon  iconfont  icon-jia1"></span>';
        html += "	</div>";
        html += "</div>";
        html += "</div>";
        html += "</div>";

        return html;
    }

    /*
     * 列表部分按钮的加、减
     * */
    //增加
    mui("body").on("tap", ".icon-jia1", function() {
        blurCancel();
        var _this_parent = this.parentNode.parentNode.parentNode.parentNode;
        var numSelf = JSON.parse(_this_parent.id).matNum;
        var maxNum = JSON.parse(_this_parent.id).storageNum;
        var valueSelf = Number(
            _this_parent.children[0].children[2].children[2].children[0].value
        );
        valueSelf += 1;
        for (var i = 0; i < setArry.length; i++) {
            if (setArry[i].matNum == numSelf) {
                setArry[i].applyNum = valueSelf;
                break;
            }
        }

        _this_parent.children[0].children[2].children[2].children[0].value =
            setArry[i].applyNum;

        //				console.log(valueSelf)
    }); //减少
    mui("body").on("tap", ".icon-jian", function() {
        blurCancel();
        var _this_parent = this.parentNode.parentNode.parentNode.parentNode;
        var numSelf = JSON.parse(_this_parent.id).matNum;
        var valueSelf = Number(
            _this_parent.children[0].children[2].children[2].children[0].value
        );
        valueSelf -= 1;
        if (valueSelf < 0) {
            showMsg("数量不能小于0！");
            return;
        }
        _this_parent.children[0].children[2].children[2].children[0].value =
            valueSelf;
    });

    /*
     *条件查询
     * */
    //确定
    mui("body").on("tap", ".queding", function() {
        blurCancel();
        setArry = [];
        loadViewList();
    });

    //取消
    mui("body").on("tap", ".quxiao", function() {
        blurCancel();
        $("#wuziName").val("");
        $("#xinghao").val("");
        $("#guige").val("");
    });

    //保存

    mui("body").on("tap", "#suretijiao", function() {
        blurCancel();
        //不常用数据保存
        var wocaoNew = wuziChooseObj;
        var list = setArry;
        var numRight = true;
        // var isSubmit = true;
        var re = /^\d+$/;
        var showMsgString = "";
        var numInputArry = $("input[class='numInput']");
        console.log(list);
        for (var i = 0; i < list.length; i++) {
            list[i].applyNum = Number(numInputArry[i].value);
            var aa = list[i];
            // if (Number(aa.applyNum) > Number(aa.storageNum)) {
            //     showMsgString += aa.matName + "\n";
            //     isSubmit = false;
            // }
            if (aa.applyNum > 0) {
                var setIn = true;
                for (var d = 0; d < wuziChooseObj.length; d++) {
                    if (wuziChooseObj[d].matNum == aa.matNum) {
                        setIn = false;
                        break;
                    }
                }
                if (setIn) {
                    wocaoNew.push(aa);
                }
            }
        }
        //			if(!numRight) {
        //				showMsg("物品数量为正整数！");
        //				return;
        //			}
        // console.log(wocaoNew);
        // if (!isSubmit) {
        //     mui.alert(showMsgString, "数量异常", function(e) {});
        // } else {
        console.log(wocaoNew);
        localStorage.setItem("wuzi-choose", JSON.stringify(wocaoNew));
        location.href = "new-apply.html";
        // }
    });

    document.getElementById("back").addEventListener("tap", function() {
        location.href = "new-apply.html";
    });
    document.addEventListener("deviceready", onDeviceReady, false);

    function onDeviceReady() {
        document.addEventListener("backbutton", onBackKeyDown, false);
    }

    function onBackKeyDown() {
        location.href = "new-apply.html";
    }

    function changeShow() {
        $("#choose").toggle();
        $("#before").toggle();
    }

    function blurCancel() {
        $("input").blur();
    }
</script>

</html>