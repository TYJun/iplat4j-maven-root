<!DOCTYPE html>
<html class="no-js">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="renderer" content="webkit" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="reference/mui/css/mui.css" />
    <link rel="stylesheet" href="reference/css/common.css" />
</head>
<style type="text/css">
    body {
        background: #eee;
    }
    
    .task {
        background: #fff;
        width: 100%;
        margin-top: 5px;
        color: #666;
        border-bottom: 1px solid #d2d2d2;
        border-top: 1px solid #d2d2d2;
        font-weight: bold;
    }
    
    .task-info {
        width: 100%;
        height: 40px;
        line-height: 40px;
        padding-left: 15px;
        padding-right: 15px;
        background: #75450d;
        color: #fff;
    }
    
    .info {
        padding-left: 15px;
        padding-right: 15px;
        padding-top: 10px;
    }
    
    .item {
        background: #fff;
        width: 100%;
        box-shadow: 2px 2px 2px #cecece;
        margin-top: 5px;
        color: #4a4a4a;
    }
    
    .item-info {
        width: 100%;
        height: 40px;
        line-height: 40px;
        padding-left: 15px;
        padding-right: 15px;
        background: #2589ad;
        color: #fff;
    }
    
    .div-radio {
        width: 33.33%;
        display: inline-block;
        float: left;
        margin-top: 8px;
    }
    
    .mui-input-row {
        clear: none;
    }
    
    .status {
        width: 100%;
        height: 50px;
    }
    
    .abnormal-div {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 99;
        background: #fff;
    }
    
    .abnormal-content {
        width: 100%;
        max-height: 400px;
        overflow-y: hidden;
        padding-top: 45px;
    }
    
    .abnormal_title {
        width: 100%;
        color: #5d5d5d;
        padding: 15px;
    }
    
    .div-picture {
        width: 100%;
        /*height: 100px;*/
    }
    
    .picture-btn {
        width: 100%;
        text-align: center;
        height: 50px;
        padding-left: 15px;
        padding-right: 15px;
    }
    
    .picture-btn button {
        margin: 8px 10px 0 0;
    }
    
    .pictures {
        padding-left: 15px;
        /*padding-right: 15px;*/
        border-top: 1px solid #eee;
    }
    
    .picture {
        height: 43px;
        line-height: 43px;
    }
    
    .picture-name {
        border-bottom: 1px solid #eee;
        color: #2196f3;
    }
    
    .remove-pic {
        background: #d6645c;
        color: #fff;
        text-align: center;
        border-bottom: 1px solid #fff;
    }
    
    .pic-show {
        position: fixed;
        top: 0;
        right: 0;
        left: 0;
        bottom: 0;
        z-index: 99;
        background: #000;
    }
    
    .flex {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
    }
    
    .flex-align-center {
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        align-items: center;
    }
    
    .flex-pack-justify {
        -webkit-box-pack: center;
        -webkit-justify-content: center;
        -ms-flex-pack: center;
        justify-content: center;
    }
</style>

<body>
    <header class="mui-bar mui-bar-nav">
        <h1 class="mui-title">实绩维护</h1>
        <button class="mui-action-back mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left">
        <span class="mui-icon mui-icon-left-nav"></span>
        返回
      </button>
        <button class="mui-btn mui-btn-blue mui-btn-link mui-pull-right save">
        保存
      </button>
    </header>

    <div id="warn" class="warn" hidden>
        <small></small>
    </div>

    <div class="mui-content">
        <div class="mui-row task">
            <!-- <div class="task-info">任务信息</div> -->
            <div class="mui-col mui-col-xs-12 info">
                任务编号：<span id="task_code"></span>
            </div>
            <div class="mui-col mui-col-xs-12 info">
                设备编码：<span id="machine_code"></span>
            </div>
            <div class="mui-col mui-col-xs-12 info">
                任务名称：<span id="task_name"></span>
            </div>
            <div class="mui-col mui-col-xs-12 info" style="padding-bottom: 10px">
                作业描述：<span id="task_desc"></span>
            </div>
        </div>

        <div id="item">
            <!-- <div id="111" class="mui-row item">
          <div class="item-info">呵呵</div>
          <div class="status">
            <div class="mui-input-row mui-radio mui-left div-radio">
              <label>正常</label>
              <input name="radio1" value="1" type="radio">
            </div>
            <div class="mui-input-row mui-radio mui-left div-radio">
              <label>异常</label>
              <input name="radio1" value="-1" type="radio">
            </div>
            <div class="mui-input-row mui-radio mui-left div-radio">
              <label>停用</label>
              <input name="radio1" value="2" type="radio">
            </div>
          </div>
          <form class="mui-input-group">
            <div class="mui-input-row">
              <label>参考结果</label>
              <input type="text" placeholder="" readonly>
            </div>
            <div class="mui-input-row">
              <label>异常描述</label>
              <input type="text" class="abnormal_desc" placeholder="异常状态下请选择异常描述" value="111" readonly>
            </div>
            <div class="mui-input-row">
              <label>结果记录</label>
              <input type="text" class="item_record" placeholder="异常状态下必填">
            </div>
          </form>
        </div> -->
        </div>
    </div>

    <div class="pic-show" hidden>
        <div class="flex flex-align-center flex-pack-justify" style="width: 100%; height: 100%">
            <img id="picture" src="" style="width: 100%; height: auto" />
        </div>
    </div>

    <!-- 异常描述选择框 -->
    <div class="abnormal-div" hidden>
        <header class="mui-bar mui-bar-nav">
            <h1 class="mui-title">异常描述</h1>
        </header>
        <div class="abnormal-content">
            <div class="abnormal_title">请选择符合本项目的异常描述</div>
            <form id="abnormal_list" class="mui-input-group"></form>
        </div>
        <div class="mui-row">
            <div class="mui-col mui-col-xs-6" style="padding: 15px">
                <button type="button" class="mui-btn mui-btn-block mui-btn-outlined cancel">
            返回
          </button>
            </div>
            <div class="mui-col mui-col-xs-6" style="padding: 15px">
                <button type="button" class="mui-btn mui-btn-primary mui-btn-block sure">
            确定
          </button>
            </div>
        </div>
    </div>
</body>
<script src="reference/mui/js/mui.js" type="text/javascript"></script>
<script src="reference/js/jquery-2.1.4.js" type="text/javascript"></script>
<script src="reference/js/common.js" type="text/javascript"></script>
<script src="../../cordova.js" type="text/javascript"></script>
<!-- <script src="./reference/js/vconsole.min.js"></script> -->
<script type="text/javascript">
    // var vConsole = new VConsole();
    var baseUrl = localStorage.getItem("url");
    var workNo = localStorage.getItem("workNo");
    var url = location.search;
    var taskId = url.substring(1, url.length);
    var _this = "";

    document.addEventListener("deviceready", onDeviceReady, false);

    function onDeviceReady() {
        var db = window.sqlitePlugin.openDatabase({
            name: "one-stop.db",
            location: "default",
        });
        db.transaction(
            function(tx) {
                //获取详情
                tx.executeSql(
                    "SELECT * FROM device_task_listDK WHERE task_id=?", [taskId],
                    function(tx, resultSet) {
                        var num = resultSet.rows.length;
                        $("#task_code").html(resultSet.rows.item(0).task_code);
                        $("#machine_code").html(resultSet.rows.item(0).machine_code);
                        $("#task_name").html(resultSet.rows.item(0).task_name);
                        $("#task_desc").html(resultSet.rows.item(0).task_desc);
                    },
                    function(e) {
                        showMsg("获取数据失败：" + e.message);
                    }
                );

                tx.executeSql(
                    // "SELECT * FROM device_task_detailDK WHERE task_id=? ORDER BY sort_no ASC",
                    "SELECT t1.*,group_concat(t2.file_path) file_path FROM device_task_detailDK t1 LEFT JOIN device_fileDK t2 ON t1.item_id=t2.item_id WHERE t1.task_id=? GROUP BY t1.item_id ORDER BY t1.sort_no ASC", [taskId],
                    function(tx, resultSet) {
                        var num = resultSet.rows.length;
                        var item = "";
                        // str = JSON.stringify(resultSet.rows.item(0))
                        // alert(str)
                        for (var i = 0; i < num; i++) {
                            // item += createItem(
                            //   resultSet.rows.item(i).item_id,
                            //   resultSet.rows.item(i).item_name,
                            //   resultSet.rows.item(i).status,
                            //   resultSet.rows.item(i).reference_value,
                            //   resultSet.rows.item(i).item_record,
                            //   "",
                            //   "",
                            //   ""
                            // );
                            item += createItem(
                                resultSet.rows.item(i).item_id,
                                resultSet.rows.item(i).item_name,
                                resultSet.rows.item(i).status,
                                resultSet.rows.item(i).reference_value,
                                resultSet.rows.item(i).item_record,
                                resultSet.rows.item(i).abnormal_reference,
                                resultSet.rows.item(i).abnormal_desc,
                                resultSet.rows.item(i).file_path
                            );
                        }
                        $("#item").html(item);
                    },
                    function(e) {
                        showMsg("获取数据失败：" + e.message);
                    }
                );
            },
            function(e) {
                showMsg(e.message);
                db.close(successcb, errorcb);
            },
            function() {
                db.close(successcb, errorcb);
            }
        );
    }

    function createItem(
        item_id,
        item_name,
        status,
        reference_value,
        item_record,
        abnormal_reference,
        abnormal_desc,
        file_path
    ) {
        //空值校验方法 //手持机不支持三元表达式
        if (item_name == null) {
            item_name = "";
        }
        if (status == null) {
            status = "";
        }
        if (reference_value == null) {
            reference_value = "";
        }
        if (item_record == null) {
            item_record = "";
        }
        if (abnormal_reference == null) {
            abnormal_reference = "";
        }
        if (abnormal_desc == null) {
            abnormal_desc = "";
        }
        var html = '<div id="' + item_id + '" class="mui-row item">';
        html += '<div class="item-info">' + item_name + "</div>";
        html += '<div class="status">';

        html += '<div class="mui-input-row mui-radio mui-left div-radio">';
        html += "<label>正常</label>";
        if (status != "-1" && status != "2") {
            html +=
                '<input name="' + item_id + '" value="1" type="radio" checked="">';
        } else {
            html += '<input name="' + item_id + '" value="1" type="radio">';
        }
        html += "</div>";
        html += '<div class="mui-input-row mui-radio mui-left div-radio">';
        html += "<label>异常</label>";
        if (status == "-1") {
            html +=
                '<input name="' + item_id + '" value="-1" type="radio" checked="">';
        } else {
            html += '<input name="' + item_id + '" value="-1" type="radio">';
        }
        html += "</div>";
        html += '<div class="mui-input-row mui-radio mui-left div-radio">';
        html += "<label>停用</label>";
        if (status == "2") {
            html +=
                '<input name="' + item_id + '" value="2" type="radio" checked="">';
        } else {
            html += '<input name="' + item_id + '" value="2" type="radio">';
        }
        html += "</div>";
        html += "</div>";
        html += '<form class="mui-input-group">';
        html += '<div class="mui-input-row">';
        html += "<label>参考结果</label>";

        html +=
            '<input type="text" placeholder="" value="' +
            reference_value +
            '" readonly>';
        html += "</div>";
        if (status != "-1")
            html += '<div class="mui-input-row abnormals" hidden>';
        else html += '<div class="mui-input-row abnormals">';
        html += "<label>异常描述</label>";

        html +=
            '<input id="' +
            item_id +
            '" name="' +
            abnormal_reference +
            '" class="abnormal_desc" type="text" placeholder="异常状态下请输入异常描述" value="' +
            abnormal_desc +
            '">';
        html += "</div>";
        html += '<div class="mui-input-row">';
        html += "<label>结果记录</label>";
        // var itemRecord = item_record == null ? "" : item_record;
        html +=
            '<input class="item_record" type="text" placeholder="异常状态下必填" value="' +
            item_record +
            '">';
        html += "</div>";
        html += "</form>";
        html += pictureElement(item_id, file_path);
        html += "</div>";
        return html;
    }

    function pictureElement(item_id, file_path) {
        var html = '<div id="' + item_id + '" class="div-picture">';
        html += '<div class="picture-btn">';
        html +=
            '<button type="button" class="mui-btn mui-btn-primary mui-btn-link camera">';
        html +=
            '<span class="mui-icon mui-icon-camera"></span> 拍摄照片</button>';
        html +=
            '<button type="button" class="mui-btn mui-btn-primary mui-btn-link album">';
        html += '<span class="mui-icon mui-icon-image"></span> 本地图片</button>';
        html += "</div>";

        html += '<div class="pictures">';

        if (file_path != null && file_path != "null") {
            var file_array = file_path.split(",");
            for (var i = 0; i < file_array.length; i++) {
                // var imgName = file_array[i].substring(
                //   file_array[i].lastIndexOf("/") + 1,
                //   file_array[i].length
                // );
                var imgName = "照片";
                html += '<div id="' + item_id + '" class="picture mui-row">';
                html +=
                    '<div id="' +
                    file_array[i] +
                    '" class="mui-col-xs-9 picture-name">' +
                    imgName +
                    "</div>";
                html += '<div class="mui-col-xs-3 remove-pic">删除</div>';
                html += "</div>";
            }
        }

        html += "</div>";

        html += "</div>";
        return html;
    }

    /**
     * 点击异常描述弹出选择界面
     */
    // mui(".mui-content").on('tap', 'input.abnormal_desc', function() {
    //   var this_status = $("input[name='"+this.id+"']:checked").val();
    //   if(this_status!="-1"){
    //     showMsg('只有"异常"状态下才可以选择异常描述');
    //     return;
    //   }

    //   _this = this;
    //   var abnormalList = this.name.split("@");
    //   // if(this.name==""||abnormalList.length==0||abnormalList==null){
    //   //   showMsg('该项异常描述还未维护，请先维护相关数据');
    //   //   return;
    //   // }
    //   var abnormal = '';
    //   for(var i=0;i<abnormalList.length;i++){
    //     abnormal += '<div class="mui-input-row mui-checkbox mui-left">';
    //     abnormal += '<label>'+abnormalList[i]+'</label>';
    //     abnormal += '<input name="checkbox" value="'+abnormalList[i]+'" type="checkbox">';
    //     abnormal += '</div>';
    //   }
    //   $("#abnormal_list").html(abnormal);
    //   $(".abnormal-div").show();
    // });

    /**
     * 状态选择处理方法，当非异常时，将异常描述变为空
     * 如果后期需要不置空，注释此方法
     */
    mui("body").on("tap", "div.div-radio", function() {
        var a = $(this).find("input").val();
        if (a != "-1") {
            $(this).parent().parent().find("input.abnormal_desc").val("");
            $(this).parent().parent().find("div.abnormals").hide();
        } else {
            $(this).parent().parent().find("div.abnormals").show();
        }
    });

    /**
     * 取消，关闭异常描述选择界面
     */
    mui("body").on("tap", "button.cancel", function() {
        $(".abnormal-div").hide();
    });

    /**
     * 确定选择的异常描述并关闭选择界面
     */
    mui("body").on("tap", "button.sure", function() {
        var abnormalValue = "";
        $('input[name="checkbox"]:checked').each(function(index, element) {
            if (index == 0) abnormalValue = $(this).val();
            else abnormalValue = abnormalValue + "," + $(this).val();
        });
        _this.value = abnormalValue;
        $(".abnormal-div").hide();
    });

    /**
     * 保存
     */
    mui("body").on("tap", "button.save", function() {
        $("input").blur();
        var itemList = new Array();
        var itemIdS = "",
            statusS = "",
            item_recordS = "",
            abnormal_descS = "";
        var readyForSave = true;
        var pic_array = $("#item .picture");
        var picList = [];
        for (var k = 0; k < pic_array.length; k++) {
            var item_id_s = pic_array.eq(k).attr("id");
            var pic_url_s = pic_array.eq(k).find("div.picture-name").attr("id");
            // alert(item_id_s+"\n"+pic_url_s+"\n");
            var picJson = {
                task_id: taskId,
                item_id: item_id_s,
                pic_url: pic_url_s,
            };
            picList.push(picJson);
        }

        var item_array = $("#item .item");
        for (var i = 0; i < item_array.length; i++) {
            itemIdS = item_array.eq(i).attr("id");
            statusS = item_array.eq(i).find("input[type='radio']:checked").val();
            item_recordS = item_array.eq(i).find("input.item_record").val();
            abnormal_descS = item_array.eq(i).find("input.abnormal_desc").val();
            // alert("abnormal_descS" + abnormal_descS);
            if (statusS == "-1") {
                if (
                    item_recordS == "" ||
                    item_recordS == null ||
                    abnormal_descS == "" ||
                    abnormal_descS == null
                )
                    readyForSave = false;
            }
            var json = {
                item_id: itemIdS,
                status: statusS,
                item_record: item_recordS,
                errorContent: abnormal_descS,
                // abnormal_desc: abnormal_descS
            };
            itemList.push(json);
        }

        // $("#item .item").each(function(index,element){
        //   itemIdS = this.id;
        //   statusS = $(this).find("input[type='radio']:checked").val();
        //   item_recordS = $(this).find("input.item_record").val();
        //   abnormal_descS = $(this).find("input.abnormal_desc").val();
        //   if(statusS=="-1"){
        //     if(item_recordS==""||item_recordS==null||abnormal_descS==""||abnormal_descS==null)
        //       readyForSave = false;
        //   }
        //   var json = {
        //     "item_id":this.id,
        //     "status":$(this).find("input[type='radio']:checked").val(),
        //     "item_record":$(this).find("input.item_record").val(),
        //     "abnormal_desc":$(this).find("input.abnormal_desc").val()
        //   }
        //   itemList.push(json);
        // });

        if (readyForSave) saveItem(itemList, picList);
        else showMsg("必须为所有异常项填写'异常描述'和'结果记录'");
    });

    function saveItem(itemList, picList) {
        // alert("itemList:" + JSON.stringify(itemList));
        var db = window.sqlitePlugin.openDatabase({
            name: "one-stop.db",
            location: "default",
        });
        db.transaction(
            function(tx) {
                for (var i = 0; i < itemList.length; i++) {
                    // alert('**:'+ itemList[i].abnormal_desc,)
                    tx.executeSql(
                        "UPDATE device_task_detailDK SET status=?,item_record=?,abnormal_desc=? WHERE item_id=?", [
                            itemList[i].status,
                            itemList[i].item_record,
                            itemList[i].errorContent,
                            itemList[i].item_id,
                        ]
                    );
                }
                tx.executeSql(
                    "UPDATE device_task_listDK SET operate_time=? WHERE task_id=?", [date_YMDHM(), taskId]
                );

                tx.executeSql("DELETE FROM device_fileDK WHERE task_id=?", [taskId]);

                for (var k = 0; k < picList.length; k++) {
                    tx.executeSql("INSERT INTO device_fileDK values (?,?,?) ", [
                        picList[k].task_id,
                        picList[k].item_id,
                        picList[k].pic_url,
                    ]);
                }
            },
            function(e) {
                showMsg(e.message);
                db.close(successcb, errorcb);
            },
            function() {
                db.close(function() {
                    showMsg("保存成功");
                    setTimeout("window.history.back()", 1000);
                }, errorcb);
            }
        );
    }

    function successcb() {}

    function errorcb() {
        alert("数据库关闭失败");
    }

    var _picture = "";
    mui("body").on("tap", "button.camera", function() {
        $("input").blur();
        _picture = $(this);
        navigator.camera.getPicture(successCallback, errorCallback, {
            //图像质量：0-100
            quality: 50,
            //数据返回类型：物理路径     注：也可以返回Base64
            destinationType: Camera.DestinationType.DATA_URL,
            //横屏拍照是否旋转
            correctOrientation: false,
            //是否保存到系统相册
            saveToPhotoAlbum: false,
        });
    });

    mui("body").on("tap", "button.album", function() {
        $("input").blur();
        _picture = $(this);
        navigator.camera.getPicture(successCallback, errorCallback, {
            //图像质量：0-100
            quality: 50,
            //数据返回类型：物理路径     注：也可以返回Base64
            destinationType: Camera.DestinationType.DATA_URL,
            sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
            mediaType: Camera.MediaType.PICTURE,
            //横屏拍照是否旋转
            correctOrientation: false,
            //是否保存到系统相册
            saveToPhotoAlbum: false,
        });
    });

    function successCallback(imageURI) {
        var imgName = imageURI.substring(
            imageURI.lastIndexOf("/") + 1,
            imageURI.length
        );
        var itemIds = _picture.parent().parent().attr("id");
        // console.log(itemIds);
        var img = '<div id="' + itemIds + '" class="picture mui-row">';
        img +=
            '<div id="' +
            imageURI +
            '" class="mui-col-xs-9 picture-name">' +
            imgName +
            "</div>";
        img += '<div class="mui-col-xs-3 remove-pic">删除</div>';
        img += "</div>";
        _picture.parent().parent().find("div.pictures").append(img);
    }

    function errorCallback() {
        alert("Failed because: " + message);
    }

    mui("body").on("tap", "div.remove-pic", function() {
        $("input").blur();
        $(this).parent().remove();
    });

    mui("body").on("tap", "div.picture-name", function() {
        $("input").blur();
        $("#picture").attr("src", this.id);
        $(".pic-show").show();
    });

    mui("body").on("tap", "div.pic-show", function() {
        $("input").blur();
        $(".pic-show").hide();
    });

    function goBack() {
        window.history.back(-1);
    }
</script>

</html>