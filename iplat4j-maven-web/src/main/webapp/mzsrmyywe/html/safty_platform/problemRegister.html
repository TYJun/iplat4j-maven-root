<!doctype html>
<html class="no-js">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="../../reference/mui/css/mui.css">
    <link rel="stylesheet" href="css/platform.css" />
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="../../reference/mui/css/mui.picker.min.css">
</head>
<STYLE TYPE="text/css">
    body {
        background: #eee;
    }
    
    .content {
        margin-top: 45px;
        padding-bottom: 60px;
    }
    
    .checkPlace {
        height: 55px;
        background-color: #FFFFFF;
        padding-top: 10px;
        padding-left: 12px;
        border-bottom: 1px solid #E1E1E1;
    }
    
    .questionslei {
        overflow: hidden;
        width: 100%;
        padding-bottom: 12px;
        background: #FFFFFF;
        margin-top: -15px;
        border-top: 1px solid #E1E1E1;
        border-bottom: 1px solid #E1E1E1;
    }
    
    .textImproves {
        overflow: hidden;
        width: 100%;
        margin-top: -15px;
    }
    
    textarea {
        margin: 0;
        height: 80px;
        padding-left: 12px;
    }
    
    .queslist {
        margin-left: 0;
        padding-left: 12px;
        margin-top: 0px;
    }
    
    .queslist li {
        list-style: none;
        float: left;
        width: 22.4%;
        height: 45px;
        margin-right: 2.4%;
        text-align: center;
        line-height: 45px;
        border: 1px solid #E1E1E1;
        border-radius: 8px;
    }
    
    .queslist li.navlis {
        margin-bottom: 12px;
    }
    
    .btn_group button {
        width: 96%;
        margin-left: 2%;
        height: 46px;
        margin-bottom: 8px;
    }
    
    .pictures {
        border-top: 1px solid #E1E1E1;
        border-bottom: 1px solid #E1E1E1;
        padding-top: 10px;
        padding-left: 2%;
        margin-bottom: 8px;
        background-color: #FFFFFF;
    }
    
    .pictures img {
        height: 80px;
        width: 80px;
    }
    
    .rangePictues img {
        height: 0px;
        width: 0%;
        margin-left: 7%;
    }
    /*.queslist .firstLi{
	border:1px solid #3B96FC;
	color:#3B96FC;
	font-weight:bold;
}*/
    
    img {
        border-radius: 10px;
    }
    
    .ulForward li {
        height: 40px;
        line-height: 40px;
        border-bottom: 1px solid darkgray;
        list-style: none;
        text-align: center;
    }
    
    .mui-spinner {
        width: 40px;
        height: 40px;
        margin-left: 45%;
        margin-top: 23%;
    }
</STYLE>

<body>
    <header id="header" class="mui-bar mui-bar-nav">
        <h1 class="mui-title">问题登记</h1>
        <button onclick="goBack()" class=" mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left">
            <span class="mui-icon mui-icon-left-nav"></span> 返回
        </button>
        <!--<button id="submit" class="mui-btn mui-btn-danger mui-btn-link mui-btn-nav mui-pull-right" style="padding-right: 5px;">
    		<div class="mui-btn mui-btn-primary" style="margin-top: -1.6px;">
					提交
				</div>
    	</button>-->
    </header>
    <div id="warn" class="warn" hidden>
        <small></small>
    </div>
    <div id="warnsss" class="warn" hidden>
        <small></small>
    </div>
    <p id="progress" class="mui-progressbar mui-progressbar-in" data-progress="20" style="display:none;"><span></span></p>
    <button id="submit" type="button" class="btn btn-block" style="z-index:100;height: 48px;position: fixed;bottom: 0px;width: 100%;background-color:  #2aabd2;color: #FFFFFF;">
        提交
    </button>
    <!--content-->
    <div class="content">
        <div class="checkPlace">
            <label>检查地点</label>
            <input id="place" type="text" placeholder="在此输入检查地点" style="width: 50%;border: none;">
            <!-- <button type="button" class="mui-btn mui-btn-primary mui-icon mui-right" style="float:right;width: 25%;height: 36px;margin-top: 1px;margin-right: 15px;">
                <a id="Checkforward" style="color: #FFFFFF;padding: 10px;margin-left: -10px;">检查地点</a>
            </button> -->
        </div>
        <p style="padding-left: 12px;height: 46px;line-height: 46px;font-weight: bold;">问题大类：</p>
        <div class="questionslei">
            <ul class="queslist">
            </ul>
        </div>
        <div style="display: flex;margin-top: 5px;">
            <p style="width:30%;padding-left: 12px;height: 46px;line-height: 46px;font-weight: bold;margin-bottom: 0px;">要求整改时间：</p>
            <input type="text" id="beginTimeHead" placeholder="选择时间" readonly style="width:70%;text-align:center;padding: 0;margin-bottom: 0">
        </div>
        <p style="padding-left: 12px;height: 46px;line-height: 46px;font-weight: bold;margin-bottom: 0px;">紧急程度：</p>
        <form id="urgentDegree" class="mui-input-group">
        </form>
        <p style="padding-left: 12px;height: 46px;line-height: 46px;font-weight: bold;">描述：</p>
        <div class="textImproves">
            <textarea id="textId" placeholder="详细情况说明及相关描述..."></textarea>
        </div>
        <p style="padding-left: 12px;height: 46px;line-height: 46px;font-weight: bold;">整改要求：</p>
        <div class="textImproves">
            <textarea id="requirement" placeholder="详细说明整改要求..."></textarea>
        </div>
        <div class="btn_group">
            <div id="picturesImg" class="pictures">
                <!--<img src="../img/icon.png"/>-->
            </div>
            <button type="button" id="btnCamera" class="mui-btn mui-btn-primary mui-icon mui-icon-camera">
                相机拍摄
            </button>
            <button type="button" id="btnPicture" class="mui-btn mui-btn-primary mui-icon mui-icon-image">
                本地上传
            </button>
        </div>
        <div id="myModal" class="child-window" style="background: #000000;opacity: 0.7;display: none;"></div>
        <div class="rangePictues" style="position: fixed;z-index:5000;bottom:170px;width:100%;display: none;">
            <img id="imgshow" class="img" src="" />
            <button type="button" id="delPic" class="mui-btn mui-btn-primary mui-btn-block" style="width: 86%;height:50px;margin: 0 auto;">删除</button>
        </div>
        <div id="myModalsss" class="child-window" style="background: #000000;opacity: 0.7;display: none;"></div>
        <div id="ulForward" style="position: fixed;z-index: 4000;width: 100%;bottom: -10px;display: none;">
            <ul class="ulForward" style="background:#E1E1E1;width: 100%;height:0px;overflow-y: auto;padding: 0;">
                <span id="roundWait" class="mui-spinner"></span>
            </ul>
        </div>
    </div>
</body>
<script src="../reference/mui/js/mui.min.js" type="text/javascript"></script>
<script src="../reference/js/jquery-2.1.4.js" type="text/javascript"></script>
<script src="../../cordova.js" type="text/javascript"></script>
<script type="text/javascript" src="../reference/mui/js/mui.picker.min.js"></script>
<script type="text/javascript">
    var baseUrl = localStorage.getItem('url');
    var _this = '',
        codes = '';
    var hospitalID = localStorage.getItem('hosId');
    var workNo = localStorage.getItem('workNo');
    var pageNum = 9;
    console.log(hospitalID);

    var progress = mui('#progress');

    $(function() {
        //问题大类
        $.ajax({
            url: baseUrl + 'MobileAgentService',
            type: 'post',
            headers: {
                serviceName: 'PRAP02',
                methodName: 'querySafty'
            },
            success: function(data) {
                var list = data.attr.param;
                var html = '';
                //console.log(data);
                if (data.msgKey == 200 || data.msgKey == '200') {
                    for (var i = 0; i < list.length; i++) {
                        var code = list[i].value;
                        var name = list[i].label;
                        html += '<li class="' + code + '" style="margin-top:14px;">' + name + '</li>';
                    }
                    $('.queslist').html(html);
                }
            }
        })

        /*$.ajax({
            url: baseUrl + 'safty',
            type: 'post',
            headers: {
                className: 'ServiceAQAP02',
                methodName: 'grade'
            },
            success: function(data) {
                console.log(data);
                if (data.respCode == "200") {*/
        var list = ["紧急", "普通"];
        var list1 = ["jj", "pt"];
        var html = '';
        for (var i = 0; i < list.length; i++) {
            html += '<div class="mui-input-row mui-radio">';
            html += '<label>' + list[i] + '</label>';
            html += '<input name="radio1" type="radio" value="' + list1[i] + '">';
            html += '</div>';
        }
        $('#urgentDegree').html(html);
        /*} else {
                    $('#warn small').html(data.respMsg);
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }
            }
        });*/
    })

    //选择问题大类
    $('.queslist').on('click', 'li', function() {
        $(this).css({
            border: '1px solid #2aabd2',
            color: '#2aabd2',
            fontWeight: 'bold'
        }).siblings().css({
            border: '',
            color: '',
            fontWeight: ''
        });
        codes = $(this).attr('class');
        names = $(this).text();
    })
    mui("body").on("tap", "#beginTimeHead", function() {
        var options = {
            "type": "date"
        };
        var beginTime;
        var pickerDate = new mui.DtPicker(options);
        pickerDate.show(function(rs) {
            $("#beginTimeHead").val(rs.text);
        });
    });

    //检查地点
    $('#Checkforward').click(function() {
        $('#myModalsss').show();
        $('#ulForward').show();
        $('.ulForward').animate({
            height: '200px'
        }, 200);
        //数据请求
        $.ajax({
            url: baseUrl + 'app_safty_query.do?queryKeyPlaceDangerMap&noDangerClass=true',
            type: 'post',
            success: function(data) {
                var list = data.obj;
                var html = '';
                if (data.respCode == 200 || data.respCode == '200') {
                    for (var i = 0; i < list.length; i++) {
                        html += '<li class="mui-table-view-cells"><a href="#">' + list[i].whereName + '</a></li>';
                    }
                    $('.ulForward').html(html);
                } else {
                    $('#roundWait').hide();
                    $('#warn small').html(data.respMsg);
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }
            },
            complete: function(XMLHttpRequest, status) { //请求完成后最终执行参数
                if (status == 'timeout') {
                    $('#roundWait').hide();
                    $('#warn small').html('加载失败！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);　　　　
                } else if (status == 'error') {
                    $('#roundWait').hide();
                    $('#warn small').html('网络异常！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }　
            }
        })
    })

    //拍摄照片
    $("#btnCamera").click(function() {
        if ($("#picturesImg").find("img").length == pageNum) {
            $("#warn small").html("最多只能上传九张图片");
            $("#warn").fadeIn(500);
            setTimeout("$('#warn').fadeOut(500)", 3000);
            return;
        };
        //$('#myModal').modal('hide');
        navigator.camera.getPicture(onSuccess, onFail, {
            quality: 50,
            destinationType: Camera.DestinationType.FILE_URI,
            sourceType: Camera.PictureSourceType.CAMERA,
            allowEdit: false,
            encodingType: Camera.EncodingType.JPEG,
            popoverOptions: CameraPopoverOptions,
            saveToPhotoAlbum: false
        });
    });

    function onSuccess(imageData) {
        var img = $('<img class="img-circle">');
        img.attr('src', imageData);
        img.appendTo('#picturesImg');
    }

    function onFail(message) {
        //alert('Failed because: ' + message);
    }

    //本地上传
    $('#btnPicture').bind('touchstart', function() {
        if ($("#picturesImg").find("img").length == pageNum) {
            $("#warn small").html("最多只能上传九张图片");
            $("#warn").fadeIn(500);
            setTimeout("$('#warn').fadeOut(500)", 3000);
            return;
        };
        navigator.camera.getPicture(function(data) {
            var img = $('<img class="img-circle">');
            img.attr('src', data);
            img.appendTo('#picturesImg');

        }, function(error) {
            //console.log('Error');
        }, {
            destinationType: Camera.DestinationType.FILE_URI,
            sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
            allowEdit: false,
            mediaType: Camera.MediaType.PICTURE
        });
    });

    //获取图片base64
    function getBase64Image(img) {
        var canvas = document.createElement("canvas");
        var image = new Image();
        image.src = img.src;
        var width;
        var height;
        // alert("宽："+image.width+"\n高："+image.height);
        if (image.width > image.height) {
            width = 450;
            height = image.height * 450 / image.width;
        } else {
            height = 450;
            width = image.width * 450 / image.height;
        }
        canvas.width = width;
        canvas.height = height;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(image, 0, 0, width, height);
        var dataURL = canvas.toDataURL("image/JPEG");
        //data:image/jpeg;base64,
        return dataURL.substring(23, dataURL.length)

        // return dataURL.replace("data:image/png;base64,", "");
    }

    //提交
    $('#submit').click(function() {
        //判断是否符合提交条件
        if ($('#place').val() == '') {
            $('#warn small').html('请录入检查地点 ！');
            $("#warn").fadeIn(500);
            setTimeout("$('#warn').fadeOut(500)", 3000);
            return;
        }
        if (codes == '') {
            $('#warn small').html('请选择问题大类 ！');
            $("#warn").fadeIn(500);
            setTimeout("$('#warn').fadeOut(500)", 3000);
            return;
        }

        var urgentDegree = $('input[type=radio]:checked').val();
        if (urgentDegree == "" || urgentDegree == null || urgentDegree == undefined || urgentDegree == "undefined") {
            $('#warn small').html('请选择紧急程度 ！');
            $("#warn").fadeIn(500);
            setTimeout("$('#warn').fadeOut(500)", 3000);
            return;
        }

        //保存图片
        var picList = new Array();
        $("#picturesImg img").each(function(index, element) {
            picList.push(getBase64Image(element));
        });
        if (picList.length == 0) {
            $('#warn small').html('请拍照 ！');
            $("#warn").fadeIn(500);
            setTimeout("$('#warn').fadeOut(500)", 3000);
            return;
        }

        $('#submit').attr('disabled', 'disabled');

        $('#warnsss small').html('正在提交中...');
        $("#warnsss").show();
        $("#progress").css("display", "");
        mui(progress).progressbar().setProgress(10);


        // var data = {
        //     'hospitalID': hospitalID,
        //     'dangerContent': $('#textId').val(),
        //     'dangerPlaceName': $('#place').val().trim(),
        //     'localTypeCode': codes,
        //     'dangerLevel': urgentDegree,
        //     'pics': picList
        // }

        // var jsonStr = JSON.stringify(data);
        var prame = {
            workNo: workNo,
            pics: JSON.stringify(picList),
            problemCategory: codes, //问题大类
            problemLocation: $('#place').val().trim(), //问题地点
            time: $('#beginTimeHead').val().trim(), //要求整改时间
            problemlevel: urgentDegree, //问题等级
            problemDesciption: $('#textId').val(), //描述
            requiredesc: $('#requirement').val() //整改要求
        };
        prame = JSON.stringify(prame);
        $.ajax({
            url: baseUrl + 'MobileAgentService',
            type: 'post',
            headers: {
                serviceName: 'PRAP03',
                methodName: 'saftyUp'
            },
            data: {
                prames: prame
            },
            success: function(data) {
                //console.log(data);
                if (data.msgKey == 200 || data.msgKey == '200') {
                    $('#warnsss').fadeOut(500);
                    $('#submit').removeAttr('disabled');
                    $("#progress").css("display", "none");
                    location.href = "homePage.html";
                } else {
                    $('#warnsss').fadeOut(500);
                    $('#submit').removeAttr('disabled');
                    mui(progress).progressbar().setProgress(60);
                    $('#warn small').html(data.msg);
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                    return;
                }
            },
            complete: function(XMLHttpRequest, status) {
                if (status == 'timeout') {
                    $('#warnsss').fadeOut(500);
                    $('#submit').removeAttr('disabled');
                    $('#warn small').html('加载失败！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);　　　　
                } else if (status == 'error') {
                    $('#warnsss').fadeOut(500);
                    $('#submit').removeAttr('disabled');
                    $('#warn small').html('网络异常！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }
            }
        })
    })

    $('#ulForward').on('click', 'li', function() {
        var texts = $(this).find('a').text();
        $('#place').val(texts);
        $('#ulForward').hide();
        $('#myModalsss').hide();
        $('.ulForward').css({
            height: '0px'
        });
    })

    //删除图片
    $('#picturesImg').on('click', 'img', function() {
        //图片src地址
        _this = $(this);
        $("#imgshow").attr("src", $(this).attr('src'));
        //显示放大图片
        $('#myModal').show();
        $('.rangePictues').show();
        $('.rangePictues img').animate({
            height: '250px',
            width: '86%'
        }, 300);
        $('.rangePictues').animate({
            bottom: '30%'
        }, 300);
    })

    //删除图片
    $("#delPic").click(function() {
        _this.remove();
        $('#myModal').hide();
        $('.rangePictues').hide();
        $('.rangePictues img').css({
            height: '0px',
            width: '0'
        });
        $('.rangePictues').css({
            bottom: '170px'
        });
    });

    $('#myModal').click(function() {
        $('#myModal').hide();
        $('.rangePictues').hide();
        $('.rangePictues img').css({
            height: '0px',
            width: '0'
        });
        $('.rangePictues').css({
            bottom: '170px'
        })
    })

    $('#imgshow').click(function() {
        $('#myModal').hide();
        $('.rangePictues').hide();
        $('.rangePictues img').css({
            height: '0px',
            width: '0'
        });
        $('.rangePictues').css({
            bottom: '170px'
        });
    })

    $('#myModalsss').click(function() {
        $('#ulForward').hide();
        $('#myModalsss').hide();
        $('.ulForward').css({
            height: '0px'
        });
    })

    function goBack() {
        location.href = "homePage.html";
    }
</script>

</html>