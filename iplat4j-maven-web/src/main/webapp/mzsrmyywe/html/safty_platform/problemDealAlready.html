<!doctype html>
<html class="no-js">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="../../reference/mui/css/mui.css">
    <link rel="stylesheet" href="../reference/mui/css/mui.picker.min.css" />
    <link rel="stylesheet" href="css/platform.css" />
    <link rel="stylesheet" href="css/common.css" />
</head>
<STYLE TYPE="text/css">
    body {
        background: #eee;
    }
    
    .content {
        margin-top: 45px;
        padding-bottom: 60px;
        overflow: hidden;
    }
    
    .content img {
        height: 80px;
        width: 80px;
        margin-top: 7px;
        margin-right: 8px;
        border-radius: 6px;
    }
    
    .content li.mui-table-view-cell span.nn {
        float: right;
        /*margin-left: 3px;*/
    }
    
    .dealtop {
        overflow: hidden;
        width: 100%;
        margin-top: -15px;
        border-top: 1px solid #E1E1E1;
    }
    
    textarea {
        margin: 0;
        margin-top: 6px;
        height: 80px;
        padding-left: 12px;
    }
    
    .ulForward li {
        height: 40px;
        line-height: 40px;
        list-style: none;
        text-align: center;
    }
    
    .btn_group button {
        width: 47.5%;
        height: 40px;
        margin-top: 4px;
    }
    
    .dealtopss {
        margin-top: -13px;
    }
    
    .mui-spinner {
        width: 40px;
        height: 40px;
        margin-left: 45%;
        top: 68%;
        position: absolute;
    }
    
    .bigImgDiv {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 999;
        background: #000;
    }
    
    .bigImg {
        text-align: center;
    }
    
    .flex {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
    }
    
    .flex-align-center {
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        align-items: center;
    }
    
    .flex-pack-justify {
        -webkit-box-pack: center;
        -webkit-justify-content: center;
        -ms-flex-pack: center;
        justify-content: center;
    }
    
    .operation-div {
        position: fixed;
        bottom: 20px;
        width: 100%;
        height: 50px;
        z-index: 1000;
        text-align: center;
    }
    
    .btn-minus,
    .btn-plus,
    .btn-close {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(132, 132, 132, 0.7);
        margin: 0 10px;
    }
</STYLE>

<body>
    <header id="header" class="mui-bar mui-bar-nav">
        <h1 class="mui-title">问题处理</h1>
        <button class="mui-action-back mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left">
            <span class="mui-icon mui-icon-left-nav"></span> 返回
        </button>
    </header>
    <div class="content">
        <p style="padding-left: 15px;height: 46px;line-height: 46px;font-weight: bold;">整改前：</p>
        <div class="dealtop">
            <ul class="mui-table-view">
                <li class="mui-table-view-cell"><span style="letter-spacing: 0.28rem;">问题号</span>：<span class="nn" id="questionNum"></span></li>
                <li class="mui-table-view-cell">检查地点：<span class="nn" id="place"></span></li>
                <li class="mui-table-view-cell">问题大类：<span class="nn" id="wenDalei"></span></li>
                <!-- <li class="mui-table-view-cell">所属部门：<span class="nn" id="depart"></span></li> -->
                <li class="mui-table-view-cell">问题说明：<span class="nn" id="introce"></span></li>
                <li class="mui-table-view-cell">整改要求：<span class="nn" id="requireDesc"></span></li>
                <li class="mui-table-view-cell">要求整改时间：<span class="nn" id="timeNeed"></span></li>
                <li class="mui-table-view-cell">整改前照片：
                    <div id="picturePrv" style="width: 100%;">
                        <!--<img src="../../../build/intermediates/assets/debug/images/big-aztec.png">-->
                    </div>
                </li>
            </ul>
        </div>
        <div id="warn" class="warn" hidden>
            <small></small>
        </div>
        <div id="warnsss" class="warn" hidden>
            <small></small>
        </div>
        <p style="padding-left: 15px;height: 46px;line-height: 46px;font-weight: bold;">整改后：</p>
        <div class="dealtopss">
        </div>
        <div class="rangePictues" style="position: fixed;z-index:5000;top:42%;left:50%;width: 100%;display: none;">
            <img id="imgshow" class="img" src="" style="width: 0;height: 0;" />
        </div>
        <span id="rounditem3" class="mui-spinner"></span>
        <div id="myModalsss" class="child-window" style="background: #000000;opacity: 0.7;display: none;"></div>
        <div id="ulForward" style="position: fixed;background:#FFFFFF;z-index: 4000;width: 100%;bottom: -14px;display: none;">
            <ul class="ulForward" style="width: 100%;height:0px;overflow-y: auto;padding: 0;">
                <!--<li class="mui-table-view-cells">
					<a href="#">中控室</a>
				</li>-->
            </ul>
        </div>
        <nav id="navBottom" class="mui-bar mui-bar-tab" style="background-color:#fff;">
            <a id="modify" class="mui-tab-item" style="background: #0090BB;color: #FFFFFF;padding-top: 4px;">
                <span class="mui-tab-label">整改驳回</span>
            </a>
            <a id="modify2" class="mui-tab-item" style="padding-top: 4px;">
                <!--<span id="noticeNum" class="mui-icon mui-icon-email"></span>-->
                <span class="mui-tab-label">整改确认</span>
            </a>
        </nav>
    </div>
    <!-- 大图DIV -->
    <div id="bigLook" class="bigImgDiv" hidden>
        <div class="bigImg" style="width:100%;height:100%;overflow: scroll;">
            <img id="picture" src="" style="width:100%;height:auto;" />
        </div>
        <div class="operation-div flex flex-align-center flex-pack-justify">
            <div id="btnClose" class="btn-close flex flex-align-center flex-pack-justify">
                <img src="img/close.png">
            </div>
            <div id="btnMinus" class="btn-minus flex flex-align-center flex-pack-justify">
                <img src="img/move.png">
            </div>
            <div id="btnPlus" class="btn-plus flex flex-align-center flex-pack-justify">
                <img src="img/add.png">
            </div>
        </div>
    </div>
</body>
<script src="../reference/mui/js/mui.min.js" type="text/javascript"></script>
<script src="../reference/js/jquery-2.1.4.js" type="text/javascript"></script>
<script src="../reference/mui/js/mui.picker.min.js"></script>
<script src="../../cordova.js" type="text/javascript"></script>
<script type="text/javascript">
    var baseUrl = localStorage.getItem('url');
    var name = localStorage.getItem('name');
    var workNo = localStorage.getItem('workNo');
    var url = location.search;
    var jsonss = JSON.parse(decodeURIComponent(url.substring(1, url.length)));
    var dangerID = jsonss.dangerID;
    var hospitalID = jsonss.hospitalID;
    var dangerResultID = '',
        flag = '',
        meno = '',
        dId = '';
    /*var btn = document.getElementById("time");*/

    $(function() {
        var prame = {
                dangerID: dangerID
            },
            prame = JSON.stringify(prame);
        $.ajax({
            url: baseUrl + 'MobileAgentService',
            type: 'post',
            headers: {
                serviceName: 'PRAP02',
                methodName: 'queryDangerDetial'
            },
            data: {
                prames: prame
            },
            success: function(data) {
                if (data.msgKey == 200 || data.msgKey == '200') {
                    var data = data.attr.param;;
                    var html = '';
                    console.log(data);

                    dangerResultID = data.dangerResultId;
                    dId = data.dangerId;

                    $('#questionNum').text(data.dangerCode);
                    $('#place').text(data.dangerWhere);
                    $('#wenDalei').text(data.localTypeName);
                    $('#depart').text(data.taskDepartName);
                    $('#introce').text(data.dangerContent);
                    $('#requireDesc').text(data.requireDesc);

                    //要求整改时间
                    var needTime = data.requiredTime;
                    $('#timeNeed').text(needTime);

                    //展示整改前图片
                    var picList = data.pic;
                    for (var j = 0; j < picList.length; j++) {
                        var pic = picList[j];
                        drawImg(pic.base64);
                    }
                    ///debugger;
                    //修改整改
                    // var resultList = data.resultPic;
                    // console.log(resultList);
                    // if (resultList.length > 0) {
                    //     for (var i = 0; i < resultList.length; i++) {
                    //         var content = resultList[i].content;
                    //         var dangerResultID = resultList[i].dangerResultID;
                    //         var picListLatter = resultList[i].path;
                    //         //var dangerFullClassName = resultList[i].dangerFullClassName;
                    //         html += ajaxListRegister(content, dangerResultID, picListLatter);
                    //     }
                    //     $('#rounditem3').hide();
                    //     $('.dealtopss').html(html);
                    // } else {
                    //     $('#rounditem3').hide();
                    // }
                    var content = data.content;
                    var resultPic = data.resultPic;
                    if (null != content) {
                        html += ajaxListRegister(content, resultPic);
                        $('#rounditem3').hide();
                        $('.dealtopss').html(html);
                    } else {
                        $('#rounditem3').hide();
                    }
                } else {
                    $('#rounditem3').hide();
                    $('#warn small').html(data.msg);
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                    return;
                }
            },
            complete: function(XMLHttpRequest, status) {
                if (status == 'timeout') {
                    $('#rounditem3').hide();
                    $('#warn small').html('加载失败！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);　
                } else if (status == 'error') {
                    $('#rounditem3').hide();
                    $('#warn small').html('网络异常！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }
            }
        })
    })

    function ajaxListRegister(content, resultPic) {
        var html = '';
        html += '<ul class="mui-table-view" style="margin-bottom:13px;">';
        //html += '<li class="mui-table-view-cell"id="Checkforward">问题分类：';
        //html += '<input id="divideQuestion" style="float: right;text-align: right;border: none;" value="' + dangerFullClassName + '" readonly/>';
        html += '</li><li class="mui-table-view-cell">整改说明：';
        html += '<p>' + content + '</p>';
        html += '<p id="textarea"></p></li>';
        html += '<li class="mui-table-view-cell">整改后照片：';
        html += '<div class="btn_group">';
        html += '<div id="picturesImg">';
        // for (var k = 0; k < picListLatter.length; k++) {
        //     html += '<img class="img-circle" src="' + baseUrl + picListLatter[k] + '">';
        // }
        for (var k = 0; k < resultPic.length; k++) {
            var pic = resultPic[k];
            var pi = pic.base64;
            html += '<img class="img-circle" src="' + "data:image/png;base64," + pi + '">';
        }
        html += '</div>';
        html += '</div> </li></ul>';
        return html;
    }

    function sureGai(param) {
        var data = {
            'dangerID': dangerID,
            'memo': meno,
            'param': param,
            'dangerResultID': dangerResultID,
            'dId': dId
        }
        var jsonss = JSON.stringify(data);

        $('#warnsss small').html('正在提交中...');
        $("#warnsss").show();

        var prame = {
            currentUser: workNo,
            parameter: jsonss
        };
        prame = JSON.stringify(prame);

        //整改确认
        $.ajax({
            url: baseUrl + 'MobileAgentService',
            type: 'post',
            headers: {
                serviceName: 'PRAP03',
                methodName: 'update3'
            },
            data: {
                prames: prame
            },
            success: function(data) {
                //console.log(data);
                if (data.msgKey == 200 || data.msgKey == '200') {
                    $("#warnsss").fadeOut(500);
                    $("#progress").css("display", "none");
                    location.href = "problemPool.html?已整改";
                } else {
                    $("#warnsss").fadeOut(500);
                    $('#warn small').html(data.msg);
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                    return;
                }
            },
            complete: function(XMLHttpRequest, status) {
                if (status == 'timeout') {
                    $("#warnsss").fadeOut(500);
                    $('#warn small').html('加载失败！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);　　　　
                } else if (status == 'error') {
                    $("#warnsss").fadeOut(500);
                    $('#warn small').html('网络异常！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }　
            }
        })
    }

    function unSureGai(param) {
        var data = {
            'dangerID': dangerID,
            'memo': meno,
            'param': param,
            'dangerResultID': dangerResultID,
            'dId': dId
        }
        var jsonss = JSON.stringify(data);

        $('#warnsss small').html('正在提交中...');
        $("#warnsss").show();

        var prame = {
            currentUser: workNo,
            parameter: jsonss
        };
        prame = JSON.stringify(prame);

        //整改确认
        $.ajax({
            url: baseUrl + 'MobileAgentService',
            type: 'post',
            headers: {
                serviceName: 'PRAP03',
                methodName: 'update3'
            },
            data: {
                prames: prame
            },
            success: function(data) {
                //console.log(data);
                if (data.msgKey == 200 || data.msgKey == '200') {
                    $("#warnsss").fadeOut(500);
                    $("#progress").css("display", "none");
                    history.back()
                } else {
                    $("#warnsss").fadeOut(500);
                    $('#warn small').html(data.msg);
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                    return;
                }
            },
            complete: function(XMLHttpRequest, status) {
                if (status == 'timeout') {
                    $("#warnsss").fadeOut(500);
                    $('#warn small').html('加载失败！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);　　　　
                } else if (status == 'error') {
                    $("#warnsss").fadeOut(500);
                    $('#warn small').html('网络异常！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }　
            }
        })
    }
    //base64
    function drawImg(imageData) {
        var img = $('<img class="img-circle">');
        img.attr('src', "data:image/png;base64," + imageData);
        img.appendTo('#picturePrv');
    }

    //整改前照片
    $('#picturePrv').on('click', 'img', function() {
        var url = $(this).attr('src');
        $('#picture').attr('src', url);
        $('#picture').css('width', '100%');
        $('#bigLook').show();
    })

    //整改后照片
    $('.dealtopss').on('click', 'ul.mui-table-view img', function() {
        var url = $(this).attr('src');
        $('#picture').attr('src', url);
        $('#picture').css('width', '100%');
        $('#bigLook').show();
    })

    //放大
    $('#btnPlus').click(function() {
        console.log($('#picture').width());
        var width = $('#picture').width() + 50;
        $('#picture').width(width);
    });

    //缩小
    $('#btnMinus').click(function() {
        var width = $('#picture').width() - 50;
        if (width > 0)
            $('#picture').width(width);
    });

    //关闭大图DIV
    $('#btnClose').click(function() {
        $('#bigLook').hide();
    });

    //点击触发选择驳回
    mui('#navBottom').on('tap', '#modify', function(e) {
        var jsonDatas = {
            'hospitalID': hospitalID,
            'dangerID': dangerID
        }
        var json = JSON.stringify(jsonDatas);

        var idText = $(this).attr('id');
        if (idText == 'home') {
            location.href = "problemPool.html?" + encodeURIComponent(json);;
        } else {
            e.detail.gesture.preventDefault();
            var btnArray = ['否', '是'];
            mui.prompt('请输入您的意见或建议：', '', '', btnArray, function(e) {
                if (e.index == 1) {
                    meno = e.value;
                    var param = '1';
                    unSureGai(param);
                }
            })
        }
    })


    //点击触发选择确认
    mui('#navBottom').on('tap', '#modify2', function(e) {
        var jsonDatas = {
            'hospitalID': hospitalID,
            'dangerID': dangerID
        }
        var json = JSON.stringify(jsonDatas);

        var idText = $(this).attr('id');
        if (idText == 'home') {
            location.href = "rejectQuestion.html?" + encodeURIComponent(json);;
        } else {
            e.detail.gesture.preventDefault();
            var btnArray = ['否', '是'];
            mui.prompt('请输入您的意见或建议：', '', '', btnArray, function(e) {
                if (e.index == 1) {
                    meno = e.value;
                    var param = '2';
                    sureGai(param);
                }
            })
        }
    })

    function goBack() {
        location.href = "problemPool.html";
    }
</script>

</html>