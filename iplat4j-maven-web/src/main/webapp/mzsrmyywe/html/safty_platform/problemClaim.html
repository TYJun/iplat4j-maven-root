<!doctype html>
<html class="no-js">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="../../reference/mui/css/mui.css">
    <link rel="stylesheet" href="../reference/mui/css/mui.picker.min.css" />
    <link rel="stylesheet" href="css/platform.css" />
    <link rel="stylesheet" href="css/common.css" />
</head>
<STYLE TYPE="text/css">
    body {
        background: #eee;
    }
    
    .content {
        margin-top: 45px;
        padding-bottom: 60px;
        overflow: hidden;
    }
    
    .content img {
        height: 80px;
        width: 80px;
        margin-top: 7px;
        margin-right: 8px;
        border-radius: 6px;
    }
    
    .content li.mui-table-view-cell span.nn {
        float: right;
        /*margin-left: 3px;*/
    }
    
    .dealtop {
        overflow: hidden;
        width: 100%;
        margin-top: 3px;
        border-top: 1px solid #E1E1E1;
    }
    
    textarea {
        margin: 0;
        margin-top: 6px;
        height: 80px;
        padding-left: 12px;
    }
    
    .ulForward li {
        height: 40px;
        line-height: 40px;
        list-style: none;
        text-align: center;
    }
    
    .btn_group button {
        width: 47.5%;
        height: 40px;
        margin-top: 4px;
    }
    
    .dealtopss {
        margin-top: -13px;
    }
    
    .mui-spinner {
        width: 40px;
        height: 40px;
        margin-left: 45%;
        top: 35%;
        position: absolute;
    }
    
    .placeDiceng {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 3001;
        background: #000;
        opacity: 0.3;
        display: none;
    }
    
    .select-left-ul {
        display: none;
        padding: 0 15px;
        margin: 0;
        position: fixed;
        z-index: 3002;
        top: 120px;
        left: 0;
        width: 80%;
        left: 10%;
        background: #fff;
        color: #333333;
        font-size: 15px;
        height: 350px;
        overflow-y: auto;
    }
    
    .select-left-ul li {
        list-style: none;
        padding: 0;
        margin: 0;
        width: 100%;
        height: 40px;
        line-height: 40px;
        text-align: center;
        border: 0;
        font-weight: lighter;
        border-bottom: 1px solid #eee;
    }
</STYLE>

<body>
    <header id="header" class="mui-bar mui-bar-nav">
        <h1 class="mui-title">问题认领</h1>
        <button onclick="goBack()" class=" mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left">
      <span class="mui-icon mui-icon-left-nav"></span>
      	返回
      </button>
        <!-- <button class=" mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-right chooseDept" style="margin-right: 0;">
      部门修改
    </button> -->
    </header>

    <div class="content">
        <!--<p style="padding-left: 15px;height: 46px;line-height: 46px;font-weight: bold;">整改前：</p>-->
        <div class="dealtop">
            <ul class="mui-table-view">
                <li class="mui-table-view-cell"><span style="letter-spacing: 0.28rem;">问题号</span>：<span class="nn" id="questionNum"></span></li>
                <li class="mui-table-view-cell">检查地点：<span class="nn" id="place"></span></li>
                <li class="mui-table-view-cell">问题大类：<span class="nn" id="wenDalei"></span></li>
                <!-- <li class="mui-table-view-cell">所属部门：<span class="nn" id="depart"></span></li> -->
                <li class="mui-table-view-cell">问题说明：<span class="nn" id="introce"></span></li>
                <li class="mui-table-view-cell">整改要求：<span class="nn" id="requireDesc"></span></li>
                <li class="mui-table-view-cell">要求整改时间：<span class="nn" id="timeNeed"></span></li>
                <li class="mui-table-view-cell">整改前照片：
                    <div id="picturePrv" style="width: 100%;">
                        <!--<img src="../../../build/intermediates/assets/debug/images/big-aztec.png">-->
                    </div>
                </li>
            </ul>
        </div>

        <div id="warn" class="warn" hidden>
            <small></small>
        </div>

        <div id="warnsss" class="warn" hidden>
            <small></small>
        </div>
        <div class="dealtopss">

        </div>

        <div id="myModal" class="child-window" style="background: #000000;opacity: 0.7;display: none;"></div>
        <div class="rangePictues" style="position: fixed;z-index:5000;top:42%;left:50%;width: 100%;display: none;">
            <img id="imgshow" class="img" src="" style="width: 0;height: 0;" />
        </div>

        <span id="rounditem3" class="mui-spinner"></span>

        <div id="myModalsss" class="child-window" style="background: #000000;opacity: 0.7;display: none;"></div>
        <div id="ulForward" style="position: fixed;background:#FFFFFF;z-index: 4000;width: 100%;bottom: -14px;display: none;">
            <ul class="ulForward" style="width: 100%;height:0px;overflow-y: auto;padding: 0;">
                <!--<li class="mui-table-view-cells">
					<a href="#">中控室</a>
				</li>-->
            </ul>
        </div>

        <nav id="navBottom" class="mui-bar mui-bar-tab" style="background-color:#fff;">
            <a id="home" class="mui-tab-item" style="background: #0090BB;color: #FFFFFF;padding-top: 4px;height:21px;">
                <!--<span class="mui-icon mui-icon-home"></span>-->
                <span class="mui-tab-label">认领</span>
            </a>
        </nav>

    </div>
    <div class="placeDiceng"></div>
    <ul class="select-left-ul">

    </ul>

</body>
<script src="../reference/mui/js/mui.min.js" type="text/javascript"></script>
<script src="../reference/js/jquery-2.1.4.js" type="text/javascript"></script>
<script src="../reference/mui/js/mui.picker.min.js"></script>
<script src="../../cordova.js" type="text/javascript"></script>
<script type="text/javascript">
    var baseUrl = localStorage.getItem('url');
    var name = localStorage.getItem('name');
    var workNo = localStorage.getItem('workNo');
    var url = location.search;
    var jsonss = JSON.parse(decodeURIComponent(url.substring(1, url.length)));
    var dangerID = jsonss.dangerID;
    var hospitalID = jsonss.hospitalID;
    var clickTrue = true;
    var dangerResultID = '',
        flag = '',
        meno = '';
    var taskDeptName = "";
    var paramId = "";
    var paramStatusCode = "";
    var paramDangerId = "";
    /*var btn = document.getElementById("time");*/

    //部门帅选
    mui("body").on("tap", ".placeDiceng", function() {
        hidediceng();
    })

    function hidediceng() {
        $(".placeDiceng").hide();
        $(".select-left-ul").hide();
    }

    function showdiceng() {
        $(".placeDiceng").show();
        $(".select-left-ul").show();
    }
    mui("body").on("tap", ".select-left-ul-li", function() {
        taskDeptName = JSON.parse(this.id).departName;
        console.log(this.id)
        hidediceng();

        $.ajax({
            url: baseUrl + 'app_safty_flowservice.do?saveForTaskDeptChange',
            type: 'post',
            data: {
                currentUser: workNo,
                //					parameter: jsonss
                dangerID: dangerID,
                pauseMemo: '',
                taskDeptName: taskDeptName
            },
            success: function(data) {
                console.log(data)
                if (data.respCode == 200) {

                    $('#warn small').html(data.respMsg);
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);　
                    $("#depart").text(taskDeptName)
                } else {
                    $('#warn small').html(data.respMsg);
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);　
                }

            },
            complete: function(XMLHttpRequest, status) {
                if (status == 'timeout') {
                    /*$("#loading").hide();*/
                    $('#rounditem1').hide();
                    $('#rounditem3').hide();
                    $('#warn small').html('加载失败！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);　
                } else if (status == 'error') {
                    /*$("#loading").hide();*/
                    $('#rounditem1').hide();
                    $('#rounditem3').hide();
                    $('#warn small').html('网络异常！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }
            }
        })

    })

    //部门帅选
    mui("body").on("tap", ".chooseDept", function() {
        showdiceng();
        $.ajax({
            url: baseUrl + 'app_safty_query.do?queryDepart',
            type: 'post',
            data: {},
            success: function(data) {
                console.log(data)
                var ss = ""
                if (data.respCode == 200) {

                    for (var i = 0; i < data.obj.length; i++) {

                        var dd = {
                            "departName": data.obj[i].departName
                        }
                        var cc = JSON.stringify(dd)
                        ss += '<li  id=\'' + cc + '\' class="select-left-ul-li">' + data.obj[i].departName + '</li>';
                    }
                    $(".select-left-ul").html(ss);
                } else {
                    $('#warn small').html(data.respMsg);
                    $("#warn").fadeIn(500);
                }

            },
            complete: function(XMLHttpRequest, status) {
                if (status == 'timeout') {
                    /*$("#loading").hide();*/
                    $('#rounditem1').hide();
                    $('#rounditem3').hide();
                    $('#warn small').html('加载失败！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);　
                } else if (status == 'error') {
                    /*$("#loading").hide();*/
                    $('#rounditem1').hide();
                    $('#rounditem3').hide();
                    $('#warn small').html('网络异常！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }
            }
        })
    })

    $(function() {
        var prame = {
            dangerID: dangerID
        };
        prame = JSON.stringify(prame);
        $.ajax({
            url: baseUrl + 'MobileAgentService',
            type: 'post',
            headers: {
                serviceName: 'PRAP02',
                methodName: 'queryDangerDetial'
            },
            data: {
                prames: prame
            },
            success: function(data) {
                if (data.msgKey == 200 || data.msgKey == '200') {
                    var data = data.attr.param;
                    var html = '';

                    $('#questionNum').text(data.dangerCode);
                    $('#place').text(data.dangerWhere);
                    $('#wenDalei').text(data.localTypeName);
                    $('#depart').text(data.taskDepartName);
                    $('#introce').text(data.dangerContent);
                    $('#requireDesc').text(data.requireDesc);

                    //要求整改时间
                    var needTime = data.requiredTime;
                    $('#timeNeed').text(needTime);

                    //获取参数
                    paramId = data.id;
                    paramStatusCode = data.statusCode;
                    paramDangerId = data.dangerId;

                    //图片下载
                    var picList = data.pic;
                    for (var j = 0; j < picList.length; j++) {
                        var pic = picList[j];
                        drawImg(pic.base64);
                    }
                    $('#rounditem3').hide();
                } else {
                    $('#rounditem3').hide();
                    $('#warn small').html(data.respMsg);
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                    return;
                }
            },
            complete: function(XMLHttpRequest, status) {
                if (status == 'timeout') {
                    $('#rounditem3').hide();
                    $('#warn small').html('加载失败！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);　
                } else if (status == 'error') {
                    $('#rounditem3').hide();
                    $('#warn small').html('网络异常！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }
            }
        })
    })

    //base64
    function drawImg(imageData) {
        var img = $('<img class="img-circle">');
        img.attr('src', "data:image/png;base64," + imageData);
        img.appendTo('#picturePrv');
    }

    //整改前照片
    $('#picturePrv').on('click', 'img', function() {
        $('#myModal').show();
        $('.rangePictues').show();
        $('.rangePictues').animate({
            top: '125px',
            left: '8%'
        }, 200);
        $('.rangePictues img').attr('src', $(this).attr('src'));
        $('.rangePictues img').animate({
            height: '250px',
            width: '84%'
        }, 200);
    })

    $('#myModal').click(function() {
        $('#myModal').hide();
        $('.rangePictues').hide();
        $('.rangePictues').css({
            top: '42%',
            left: '50%'
        });
        $('.rangePictues img').css({
            height: '0',
            width: '0'
        });
    })

    $('img').click(function() {
        $('#myModal').hide();
        $('.rangePictues').hide();
        $('.rangePictues').css({
            top: '42%',
            left: '50%'
        });
        $('.rangePictues img').css({
            height: '0',
            width: '0'
        });
    })

    //点击触发选择
    mui('#navBottom').on('tap', 'a.mui-tab-item', function(e) {

        if (!clickTrue) {
            console.log("不要重复点击")
            return;
        }
        clickTrue = false;
        var prame = {
            workNo: workNo,
            id: paramId,
            statusCode: paramStatusCode,
            dangerId: paramDangerId
        };
        prame = JSON.stringify(prame);
        $.ajax({
            url: baseUrl + 'MobileAgentService',
            type: "post",
            async: true,
            headers: {
                serviceName: 'PRAP03',
                methodName: 'claim'
            },
            data: {
                prames: prame
            },
            success: function(data) {
                console.log(data)
                if (data.msgKey == 200 || data.msgKey == '200') {
                    $('#warn small').html(data.msg);
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500);location.href='problemPool.html';", 3000);
                    history.back()
                } else {
                    $('#warn small').html(data.msg);
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                    clickTrue = true;
                    return;
                }
            },
            complete: function(XMLHttpRequest, status) {
                if (status == 'timeout') {
                    $('#rounditem4').hide();
                    $('#warn small').html('加载失败！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);　
                } else if (status == 'error') {
                    $('#rounditem4').hide();
                    $('#warn small').html('网络异常！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }
            }
        })
    })

    function goBack() {
        location.href = "problemPool.html";
    }
</script>

</html>