<!doctype html>
<html class="no-js">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="../../reference/mui/css/mui.css">
    <link rel="stylesheet" href="css/platform.css" />
    <link rel="stylesheet" href="css/common.css" />
</head>
<STYLE TYPE="text/css">
    body {
        background: #EEEEEE;
    }
    
    .mui-card {
        width: 97%;
        margin: 0 auto;
        margin-top: 7px;
    }
    
    .alert {
        background: #F5F5F5;
        border-top: 1px solid #E8E8E8;
        border-bottom: 2px solid #E8E8E8;
        background-color: #F5F5F5;
        height: 3.2rem;
        line-height: 3.2rem;
        text-align: center;
        margin-bottom: 60px;
    }
    
    .mui-spinner {
        width: 40px;
        height: 40px;
        margin-left: 45%;
        margin-top: 23%;
        display: none;
    }
    
    .warn {
        z-index: 4000;
    }
    
    .mui-sliders {
        position: fixed;
        z-index: 2555;
        top: 200px;
        width: 100%;
    }
    
    .mui-control-content {
        margin-top: 200px;
    }
    
    .titleFloat li {
        list-style: none;
        float: left;
        width: 33.333%;
        text-align: center;
        padding: 10px 0 10px 0;
    }
    
    .search {
        width: 100%;
        height: 117px;
        background: #FFFFFF;
        position: fixed;
        z-index: 3000;
        border-bottom: 2px solid darkgray;
        padding-top: 4px;
    }
    
    .mui-input-row {
        margin-bottom: -2px;
    }
    
    .inputSearch {
        margin-top: -2.5px;
        text-align: right;
    }
    
    .ulForward li {
        height: 40px;
        line-height: 40px;
        border-bottom: 1px solid darkgray;
        list-style: none;
        text-align: center;
    }
</STYLE>

<body>
    <header id="header" class="mui-bar mui-bar-nav">
        <h1 class="mui-title">问题台账</h1>
        <button class="mui-action-back mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left">
      <span class="mui-icon mui-icon-left-nav"></span>
      	返回
      </button>
    </header>

    <div id="warn" class="warn" hidden>
        <small></small>
    </div>

    <div class="mui-content">
        <div class="search">
            <!-- <div class="mui-input-row" name="0">
					<label>责任部门：</label>
					<input type="text" class="inputSearch" id="input1" oninput="searchInput(this.value)" placeholder="点击选择责任部门">
				</div> -->
            <div class="mui-input-row mui-input-rowss" name="1">
                <label>问题大类：</label>
                <input type="text" class="inputSearch" id="input2" placeholder="点击选择问题大类" readonly="">
            </div>
            <div class="mui-input-row">
                <label>问题状态：</label>
                <input type="text" class="inputSearch" value="已确认" readonly="">
            </div>
        </div>

        <div id="slider">
            <div id="sliderSegmentedControl" class="mui-segmented-control mui-segmented-control-inverted" style="position: fixed;z-index:3000;top: 160px;">
                <a id="all" class="mui-control-item mui-active" href="#item3task">
						所有
					</a>
                <a id="monthes" class="mui-control-item" href="#item1task">
						近一月
					</a>
                <a id="weekDay" class="mui-control-item" href="#item4task">
						近一周
					</a>
                <a id="days" class="mui-control-item" href="#item5task">
						近三天
					</a>
            </div>

            <!--<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6"></div>-->

            <div class="mui-slider-group" style="height:100%;margin-top: 47px;">
                <div class="mui-sliders">
                    <div>
                        <ul class="mui-table-view">
                            <li class="mui-table-view-cell mui-table-view-cellsss" style="background: #989898;color: #FFFFFF;font-weight: bold;padding: 0;">
                                <ul class="titleFloat" style="padding: 0;padding-top: 2px;padding-bottom: 2px;">
                                    <li>问题号</li>
                                    <li>状态</li>
                                    <li>问题大类</li>
                                    <!-- <li>所属部门</li> -->
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>

                <div id="item3task" class="mui-slider-item mui-control-content mui-active">
                    <div id="allList">

                    </div>
                    <div id='loadMoreAll' class='alert' name='0'>
                        加载更多
                    </div>
                    <span id="roundallList" class="mui-spinner"></span>
                </div>

                <div id="item1task" class="mui-slider-item mui-control-content" style="height:100%;">
                    <div id="mothesList">

                    </div>
                    <div id='loadMoreMothes' class='alert' name='0' style="margin-top: 8px;">
                        加载更多
                    </div>
                    <span id="rounditem1" class="mui-spinner"></span>
                </div>

                <div id="item4task" class="mui-slider-item mui-control-content" style="height:100%;">
                    <div id="weekList">

                    </div>
                    <div id='loadMoreWeek' class='alert' name='0' style="margin-top: 8px;">
                        加载更多
                    </div>
                    <span id="rounditem4" class="mui-spinner"></span>
                </div>

                <div id="item5task" class="mui-slider-item mui-control-content" style="height:100%;">
                    <div id="dayList">

                    </div>
                    <div id='loadMoreDay' class='alert' name='0' style="margin-top: 8px;">
                        加载更多
                    </div>
                    <span id="rounditem5" class="mui-spinner"></span>
                </div>
            </div>
        </div>
        <div id="myModalsss" class="child-window" style="background: #000000;opacity: 0.7;display: none;z-index: 4111;"></div>
        <div id="ulForward" style="position: fixed;z-index: 4200;width: 100%;bottom: -10px;display: none;">
            <ul class="ulForward" style="background:#E1E1E1;width: 100%;height:0px;overflow-y: auto;padding: 0;">
                <span id="roundWait" class="mui-spinner" style="height: 40px;width: 40px;"></span>
            </ul>
        </div>
    </div>

</body>
<script src="../reference/mui/js/mui.min.js" type="text/javascript"></script>
<script src="../reference/js/jquery-2.1.4.js" type="text/javascript"></script>
<script src="../../cordova.js" type="text/javascript"></script>
<script type="text/javascript">
    var baseUrl = localStorage.getItem('url');
    var timeParam = "",
        localTypeName = "",
        taskDeptName = "",
        flowStatusCode = "";
    var row = 15;
    var page = 1;

    //几种状态的数据请求
    ajaxData();

    function ajaxData() {
        var localTypeName = $('#input2').val();
        //等待转动圈
        $('#rounditem1').css('display', 'block');
        $('#rounditem4').css('display', 'block');
        $('#rounditem5').css('display', 'block');
        $('#roundallList').css('display', 'block');
        var prame = {
            timeParam: timeParam,
            localTypeName: localTypeName,
            taskDeptName: taskDeptName,
            flowStatusCode: '99',
            row: row,
            page: page
        };
        prame = JSON.stringify(prame);
        //ajax异步请求
        $.ajax({
            url: baseUrl + 'MobileAgentService',
            type: 'post',
            headers: {
                serviceName: 'PRAP02',
                methodName: 'quertSaftyLedger'
            },
            data: {
                prames: prame
            },
            success: function(data) {
                var list = data.attr.param;
                var html = '';


                if (data.msgKey == 200 || data.msgKey == '200') {
                    for (var i = 0; i < list.length; i++) {
                        var s = i;
                        var createTime = list[i].createTime;
                        var localTypeName = list[i].localTypeName;
                        if (localTypeName == undefined || localTypeName == 'undefined') {
                            localTypeName = '';
                        } else {
                            localTypeName = list[i].localTypeName;
                        }
                        var dangerPlaceName = list[i].dangerPlaceName;
                        var requireDesc = list[i].requireDesc;
                        var dangerID = list[i].dangerID;
                        // var hospitalID = list[i].hospitalID;
                        var taskDepartName = list[i].taskDepartName;
                        var dangerCode = list[i].dangerCode;
                        //							var indexCode = dangerCode.indexOf('-');
                        //							dangerCode = dangerCode.substring(0, indexCode);

                        var flowStatusCode = list[i].flowStatusCode;

                        html += poolFunss(createTime, localTypeName, dangerPlaceName, requireDesc, dangerID, dangerCode, flowStatusCode, s);
                    }
                    if (timeParam == "") {
                        if (list.length < row) {
                            $('#loadMoreAll').html('暂无更多数据');
                        } else {
                            $('#loadMoreAll').html('加载更多');
                        }
                        $('#roundallList').hide();
                        $('#allList').html(html);
                    } else if (timeParam == "30") {
                        if (list.length < row) {
                            $('#loadMoreMothes').html('暂无更多数据');
                        } else {
                            $('#loadMoreMothes').html('加载更多');
                        }
                        $('#rounditem1').hide();
                        $('#mothesList').html(html);
                    } else if (timeParam == "7") {
                        if (list.length < row) {
                            $('#loadMoreWeek').html('暂无更多数据');
                        } else {
                            $('#loadMoreWeek').html('加载更多');
                        }
                        $('#rounditem4').hide();
                        $('#weekList').html(html);
                    } else if (timeParam == "3") {
                        if (list.length < row) {
                            $('#loadMoreDay').html('暂无更多数据');
                        } else {
                            $('#loadMoreDay').html('加载更多');
                        }
                        $('#rounditem5').hide();
                        $('#dayList').html(html);
                    }
                } else {
                    $('#roundallList').hide();
                    $('#rounditem5').hide();
                    $('#rounditem4').hide();
                    $('#rounditem1').hide();
                    $('#warn small').html(data.respMsg);
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }
            },
            complete: function(XMLHttpRequest, status) {
                if (status == 'timeout') {
                    /*$("#loading").hide();*/
                    $('#roundallList').hide();
                    $('#rounditem5').hide();
                    $('#rounditem4').hide();
                    $('#rounditem1').hide();
                    $('#warn small').html('加载失败！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);　
                } else if (status == 'error') {
                    /*$("#loading").hide();*/
                    $('#roundallList').hide();
                    $('#rounditem5').hide();
                    $('#rounditem4').hide();
                    $('#rounditem1').hide();
                    $('#warn small').html('网络异常！');
                    $("#warn").fadeIn(500);
                    setTimeout("$('#warn').fadeOut(500)", 3000);
                }
            }
        })
    }

    function poolFunss(createTime, localTypeName, dangerPlaceName, requireDesc, dangerID, dangerCode, flowStatusCode, s) {
        var html = '';
        html += '<ul class="mui-table-view"';
        if (s % 2 == 0) {
            html += 'style="background: #FFFFFF;"';
        } else {
            html += 'style="background: #FAFAFA;"';
        }
        html += '>';
        html += '<li class="mui-table-view-cell mui-table-view-cellsss" dangerID="' + dangerID + '" style="padding: 0;">';
        html += '<ul class="titleFloat" style="padding: 0;">';
        html += '<li style="padding-top: 20px;"><a >' + dangerCode + '</a></li>';
        html += '<li style="padding-top: 20px;">';


        html += '结束';


        html += '</li><li style="padding-top: 20px;">' + localTypeName + '</li></ul></li></ul>';
        return html;
    }

    mui('#sliderSegmentedControl').on('tap', 'a.mui-control-item', function() {
        var idText = $(this).attr('id');
        if (idText == 'all') {
            row = 10;
            timeParam = "";
            ajaxData();
        } else if (idText == 'monthes') {
            row = 10;
            timeParam = "30";
            ajaxData();
        } else if (idText == 'weekDay') {
            row = 10;
            timeParam = '7';
            ajaxData();
        } else if (idText == 'days') {
            row = 10;
            timeParam = '3';
            ajaxData();
        }
    })

    //问题处理
    $('#item3task').on('click', 'li.mui-table-view-cellsss', function() {
        var jsonData = {
            // 'hospitalID': $(this).attr('hospitalID'),
            'dangerID': $(this).attr('dangerID'),
            'pageBack': '0'
        }
        var json = JSON.stringify(jsonData);
        location.href = "problemAccountDetail.html?" + encodeURIComponent(json);
    })

    //已整改
    $('#item1task').on('click', 'li.mui-table-view-cellsss', function() {
        var jsonData = {
            // 'hospitalID': $(this).attr('hospitalID'),
            'dangerID': $(this).attr('dangerID'),
            'pageBack': '0'
        }
        var json = JSON.stringify(jsonData);
        location.href = "problemAccountDetail.html?" + encodeURIComponent(json);
    })

    //与我相关
    $('#item4task').on('click', 'li.mui-table-view-cellsss', function() {
        var jsonData = {
            // 'hospitalID': $(this).attr('hospitalID'),
            'dangerID': $(this).attr('dangerID'),
            'pageBack': '0'
        }
        var json = JSON.stringify(jsonData);
        location.href = "problemAccountDetail.html?" + encodeURIComponent(json);
    })

    //与我相关
    $('#item5task').on('click', 'li.mui-table-view-cellsss', function() {
        var jsonData = {
            // 'hospitalID': $(this).attr('hospitalID'),
            'dangerID': $(this).attr('dangerID'),
            'pageBack': '0'
        }
        var json = JSON.stringify(jsonData);
        location.href = "problemAccountDetail.html?" + encodeURIComponent(json);
    })

    //选择查询
    var namess;
    $('.search').on('click', 'div.mui-input-rowss', function(e) {
        namess = $(this).attr('name');
        $('#roundWait').show();
        $('#myModalsss').show();
        $('#ulForward').show();
        $('.ulForward').animate({
            height: '240px'
        }, 200);

        if (namess == '1') {
            //问题大类
            $.ajax({
                url: baseUrl + 'MobileAgentService',
                type: 'post',
                headers: {
                    serviceName: 'PRAP02',
                    methodName: 'querySafty'
                },
                success: function(data) {
                    var list = data.attr.param;
                    var html = '';
                    //console.log(data);
                    if (data.msgKey == 200 || data.msgKey == '200') {
                        for (var i = 0; i < list.length; i++) {
                            var code = list[i].value;
                            var name = list[i].label;
                            //var depart = list[i].depart;
                            /*html += '<li class="'+code+'" name="'+depart+'" style="margin-top:14px;">'+name+'</li>';*/
                            //html += '<li class="mui-table-view-cells"><a href="#" class="' + code + '" name="' + depart + '">' + name + '</a></li>';
                            html += '<li class="mui-table-view-cells"><a href="#" class="' + code + '" >' + name + '</a></li>';
                        }
                        $('.ulForward').html(html);
                    }
                }
            })
        } else if (namess == '2') {
            var arrayList = [{
                'name': '所有',
                'statusCode': ''
            }, {
                'name': '待认领',
                'statusCode': '20'
            }, {
                'name': '已认领',
                'statusCode': '30'
            }, {
                'name': '已处理',
                'statusCode': '80'
            }, {
                'name': '已确认',
                'statusCode': '99'
            }]
            var html = '';
            for (var i = 0; i < arrayList.length; i++) {
                var name = arrayList[i].name;
                var statusCode = arrayList[i].statusCode;
                html += '<li class="mui-table-view-cells"><a href="#" statusCode="' + statusCode + '">' + name + '</a></li>';
            }
            $('.ulForward').html(html);
        }
    })

    function searchInput(src) {
        /*namess= '0';*/
        taskDeptName = src;
        /*localTypeName= "";*/
        ajaxData();
    }

    $('#myModalsss').click(function() {
        $('#ulForward').hide();
        $('#myModalsss').hide();
        $('.ulForward').css({
            height: '0px'
        });
    })

    $('#ulForward').on('click', 'li', function(e) {
        var texts = $(this).find('a').text();

        //alert(namess);
        if (namess == '1') {
            $('#input2').val(texts);
            localTypeName = texts;
            ajaxData();
        } else if (namess == '2') {
            var statusCode = $(this).find('a').attr('statusCode');
            $('#input3').val(texts);
            flowStatusCode = statusCode;
            ajaxData();
        }

        $('#ulForward').hide();
        $('#myModalsss').hide();
        $('.ulForward').css({
            height: '0px'
        });
    })

    //加载更多
    $('#loadMoreMothes').click(function() {
        var nameText = $(this).text();
        if (nameText == '加载更多') {
            $(this).text('正在加载中...');
            row += 10;
            ajaxData();
        }
    })

    $('#loadMoreWeek').click(function() {
        var nameText = $(this).text();
        if (nameText == '加载更多') {
            $(this).text('正在加载中...');
            row += 10;
            ajaxData();
        }
    })

    $('#loadMoreAll').click(function() {
        var nameText = $(this).text();
        if (nameText == '加载更多') {
            $(this).text('正在加载中...');
            row += 10;
            ajaxData();
        }
    })

    $('#loadMoreDay').click(function() {
        var nameText = $(this).text();
        if (nameText == '加载更多') {
            $(this).text('正在加载中...');
            row += 10;
            ajaxData();
        }
    })

    function goBack() {
        location.href = "homePage.html";
    }
</script>

</html>