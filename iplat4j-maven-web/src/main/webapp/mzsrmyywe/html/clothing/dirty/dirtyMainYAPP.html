<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="../reference/mui/css/mui.css">
    <link rel="stylesheet" href="../reference/css/iconfont.css">
    <link rel="stylesheet" href="../reference/mui/css/mui.picker.min.css">
    <link rel="stylesheet" href="../reference/css/colorGreen.css" />
    <link rel="stylesheet" href="../reference/css/loading.css" />
    <link rel="stylesheet" href="../../reference/css/common.css">
    <link rel="stylesheet" href="../reference/css/clothCommon.css" />
</head>
<style>
    .main {
        margin-top: 55px;
        background-color: white;
    }
    
    .total {
        float: right;
        margin-right: 10%;
    }
    
    .scan {
        position: fixed;
        /*bottom: 15px;*/
        left: 15px;
        width: 60px;
        z-index: 11;
    }
    
    .round {
        border: 1px solid #ccc;
        width: 60px;
        height: 60px;
        line-height: 29px;
        text-align: center;
        color: #fff;
        background-color: #ccc;
        filter: alpha(opacity=80);
        /* 用于IE浏览器－透明度为20%*/
        -moz-opacity: 0.8;
        /*  用于Moz + Firefox－透明度为20%*/
        opacity: 0.8;
        -webkit-border-radius: 60px;
        -moz-border-radius: 60px;
        -o-border-radius: 60px;
        border-radius: 60px;
    }
    
    .round img {
        margin-top: 4px;
        margin-left: 2px;
    }
    
    .mui-card {
        background-color: #30c37c;
        color: white;
    }
    
    .mui-card-content {
        padding: 10px;
        display: flex;
        justify-content: space-between;
    }
    
    .mask {
        height: 70%;
    }
</style>

<body>
    <header class="mui-bar mui-bar-nav backColor">
        <h1 class="mui-title">科室清点</h1>
        <button id="back" class="mui-btn mui-btn-link mui-btn-nav mui-pull-left">
            <span class="mui-icon mui-icon-left-nav"></span>
        </button>
        <button id="search" class="mui-btn mui-btn-link mui-btn-nav mui-pull-right">
            <span class="mui-icon mui-icon-search"></span>
        </button>
    </header>
    <!-- tab页 -->
    <div class="top-part backColor">
        <div class="top-bar">
            <span id="1" class="choose">已确认</span>
            <span id="3">未确认</span>
        </div>
    </div>
    <!-- 扫码 -->
    <div class="scan" id="scan">
        <div class="round" id="round">
            <img src="../../../img/相机48.png" alt="">
        </div>
    </div>
    <div class="main">
        <div id="chooseDept" style="margin-top: 100px;">
            <input type="text" placeholder="输入科室" readonly id="initDept">
        </div>
        <div class="list">
            <ul id="list">
                <!-- <li class="mui-table-view-cell">
                    <div class="mui-card">
                        <div class="mui-card-header">信息科</div>
                        <div class="mui-card-content">
                            <span>2020-07-17</span>
                            <span>发放数量：20</span>
                        </div>
                    </div>
                </li>
                <li class="mui-table-view-cell">
                    <div class="mui-card">
                        <div class="mui-card-header">信息科</div>
                        <div class="mui-card-content">
                            <span>2020-07-17</span>
                            <span>发放数量：30</span>
                        </div>
                    </div>
                </li>
                <li class="mui-table-view-cell">
                    <div class="mui-card">
                        <div class="mui-card-header">信息科</div>
                        <div class="mui-card-content">
                            <span>2020-07-17</span>
                            <span>发放数量：20</span>
                        </div>
                    </div>
                </li> -->
            </ul>
        </div>
    </div>
    <!-- 遮罩 -->
    <div class="mask"></div>
    <!-- 查询条件 -->
    <div class="searchDiv">
        <header class="mui-bar mui-bar-nav backColor">
            <h1 class="mui-title">查询</h1>
        </header>
        <!-- 时间 -->
        <div class="mui-row row-content" style="margin-top: 50px;">
            <div class="mui-col-sm-4 mui-col-xs-4">时间</div>
            <div class="mui-col-sm-3 mui-col-xs-3">
                <input type="text" id="beginTime" placeholder="开始时间" readonly>
            </div>
            <div class="mui-col-sm-1 mui-col-xs-1 middle">-</div>
            <div class="mui-col-sm-3 mui-col-xs-3">
                <input type="text" id="endTime" placeholder="截止时间" readonly>
            </div>
            <div class="mui-col-sm-1 mui-col-xs-1 middle">
                <span class="mui-icon mui-icon-arrowright fontColor"></span>
            </div>
        </div>
        <!-- 状态 -->
        <!-- <div class="mui-row row-content">
            <div class="mui-col-sm-8 mui-col-xs-8">状态</div>
            <div class="mui-col-sm-3 mui-col-xs-3">
                <input type="text" id="statusSearch" placeholder="请选择状态" readonly>
            </div>
            <div class="mui-col-sm-1 mui-col-xs-1 middle">
                <span class="mui-icon mui-icon-arrowright fontColor"></span>
            </div>
        </div> -->
        <!-- 确认按钮 -->
        <div class="searchBtn">
            <span class="reset">重置</span>
            <span class="sure backColor">查询</span>
        </div>
    </div>
</body>
<script type="text/javascript" src="../reference/mui/js/mui.min.js"></script>
<script type="text/javascript" src="../reference/mui/js/jquery-2.1.4.js"></script>
<script type="text/javascript" src="../reference/mui/js/mui.picker.min.js"></script>
<script type="text/javascript" src="../reference/mui/js/baseInfo.js"></script>
<script type="text/javascript" src="../../reference/js/mui.loading.js"></script>
<!-- <script type="text/javascript" src="../../../cordova.js"></script> -->
<script>
    var baseUrl = localStorage.getItem("url");
    var dataGroupCode = localStorage.getItem("dataGroupCode");
    var url = decodeURI(window.location.href.split("?")[1]);
    var deptName = url.split("&")[0];
    var deptNum = url.split("&")[1];
    var deptNameInit = url.split("&")[0];
    var deptNumInit = url.split("&")[1];
    var recycleTime = ""
    var totalNum = 0;
    var status = "";
    var recycleNo = "";
    $(function() {
        init()
    })

    function init() {
        mui.showLoading("正在加载", "div");
        if (deptNumInit == null || deptNumInit == undefined) {
            deptNumInit = "";
            deptNameInit = ""
        }
        $("#initDept").val(deptNameInit);
        var listHtml = "";
        $.ajax({
            type: 'get',
            url: baseUrl + "app_ManualController.do?getQuiltcenterDiry",
            data: {
                dataGroupCode: dataGroupCode,
                beginTime: "",
                endTime: "",
            },
            success: function(data) {
                mui.hideLoading();
                // console.log(data);
                var data = JSON.parse(data);
                console.log(data)
                if (data.respCode != "200") {
                    mui.toast(data.respMsg);
                    return;
                }
                var list = data.obj.rows;
                if (list.length == 0) {
                    mui.toast("当前没有数据！");
                    return;
                }
                var quiltcenterDiryItemBills = "";
                for (var i = 0; i < list.length; i++) {
                    deptName = list[i].deptName;
                    deptNum = list[i].deptNum;
                    recycleNum = list[i].recycleNum;
                    date = list[i].date;
                    recycleNo = list[i].recycleNo;
                    // quiltcenterDiryItemBills = list[i].quiltcenterDiryItemBills;
                    // quiltcenterDiryItemBills.forEach(element => {
                    //     totalNum += Number(element.recycleNum)
                    // });
                    if (list[i].recycleNum != 0) {
                        listHtml += createHtml(date, deptName, deptNum, recycleNum, recycleNo);
                    }

                }
                $("#list").html(listHtml);
            }
        })
    }


    //列表html
    function createHtml(date, deptName, deptNum, recycleNum, recycleNo) {
        var html = "";
        html = `<li class="mui-table-view-cell">
                    <div class="mui-card">
                        <div class="mui-card-header" deptNum="${deptNum}" recycleNo="${recycleNo}">${deptName}</div>
                        <div class="mui-card-content">
                            <span>${date}</span>
                            <span>清点数量：${recycleNum}</span>
                        </div>
                    </div>
                </li>`
        return html;
    }
    //移动扫码框
    touchMove("scan")


    //卡片详情跳转
    $("#list").on("click", ".mui-card", function() {
        var detailDeptNum = $(this).find(".mui-card-header").attr("deptNum");
        var detailDeptName = $(this).find(".mui-card-header").html();
        var recycleNo = $(this).find(".mui-card-header").attr("recycleNo");
        console.log(detailDeptNum);
        console.log(detailDeptName);
        console.log(recycleNo);
        localStorage.setItem("detailDeptNum", detailDeptNum);
        localStorage.setItem("detailDeptName", detailDeptName);
        location.href = "detailListYAPP.html?" + "&" + recycleNo;
    })

    //搜索框
    $('#search').click(function() {
            $('.searchDiv').show()
            $('.mask').css("height", "100%");
            $('.mask').show()
        })
        //时间条件
    mui("body").on("tap", "#beginTime", function() {
        var options = {
            "type": "date"
        };
        var pickerDate = new mui.DtPicker(options);
        pickerDate.show(function(rs) {
            $("#beginTime").val(rs.text);
        });
    });

    mui("body").on("tap", "#endTime", function() {
        var options = {
            "type": "date"
        };
        var pickerDate = new mui.DtPicker(options);
        pickerDate.show(function(rs) {
            $("#endTime").val(rs.text);
        });
    });
    //状态选择
    mui("body").on("tap", "#statusSearch", function() {
        var picker = new mui.PopPicker();
        picker.setData([{
            value: "first",
            text: "已确认"
        }, {
            value: "second",
            text: "未确认"
        }])
        picker.show(function(getSelectedItems) {
            //console.log(getSelectedItems)
            $("#statusSearch").val(getSelectedItems[0].text);
        })
    });

    //查询
    mui("body").on("tap", ".sure", function() {
        var timeStart = $("#beginTime").val();
        var timeEnd = $("#endTime").val();
        var aa = new Date(timeStart).getTime();
        var bb = new Date(timeEnd).getTime();

        if (aa > bb) {
            mui.toast('截止时间不能早于开始时间！')
            return;
        } else {
            $('.searchDiv').hide();
            $('.mask').hide();
            console.log($("#statusSearch").val());
            // if($("#statusSearch")=='未确认'){
            //      applyStatus=0;
            // }
            // else if($("#statusSearch")=='已确认'){
            //     applyStatus=1;
            // }
            beginTime = timeStart;
            endTime = timeEnd;

            var listHtml = '';
            $.ajax({
                url: baseUrl + 'app_ManualController.do?getQuiltcenterDiry',
                type: 'get',
                data: {
                    dataGroupCode: dataGroupCode,
                    beginTime: beginTime,
                    endTime: endTime
                },
                success: function(data) {
                    $("#list").html("");
                    mui.hideLoading();
                    var data = JSON.parse(data);
                    console.log(data)
                    if (data.respCode != "200") {
                        mui.toast(data.respMsg);
                        return;
                    }
                    var list = data.obj.rows;
                    if (list.length == 0) {
                        mui.toast("当前没有数据！");
                        return;
                    }
                    var quiltcenterDiryItemBills = "";
                    for (var i = 0; i < list.length; i++) {
                        deptName = list[i].deptName;
                        deptNum = list[i].deptNum;
                        recycleNum = list[i].recycleNum;
                        date = list[i].date;
                        status = list[i].status;
                        recycleNo = list[i].recycleNo;
                        // quiltcenterDiryItemBills = list[i].quiltcenterDiryItemBills;
                        // quiltcenterDiryItemBills.forEach(element => {
                        //     totalNum += Number(element.recycleNum)
                        // });
                        if (list[i].recycleNum != 0) {
                            listHtml += createHtml(date, deptName, deptNum, recycleNum, recycleNo);
                        }

                    }
                    $("#list").html(listHtml);
                }
            })
        }
        $('#statusSearch').val('')
        $('#beginTime').val('')
        $('#endTime').val('')
    })

    //重置
    mui("body").on("tap", ".reset", function() {
        $('#statusSearch').val('')
        $('#beginTime').val('')
        $('#endTime').val('')
        $('.searchDiv').hide()
        $('.mask').hide()
    })

    //关闭弹窗
    $('.mask').click(function() {
        $('#statusSearch').val('')
        $('#beginTime').val('')
        $('#endTime').val('')
        $('.searchDiv').hide()
        $('.mask').hide()
    })


    //选择科室
    $("#chooseDept").click(function() {
        location.href = "scanDepartment.html?1"
    })

    //扫描科室
    mui(".scan").on('tap', '#round', function() {
        // location.href = "detailListAPP.html"
        cordova.plugins.barcodeScanner.scan(
            function(result) {
                var info = result.text;
                localStorage.setItem("initDeptNum", info);
                getDeptName(info);

            },
            function(error) {
                mui.toast('获取信息失败！');
                return;
            }
        );
    });

    function getDeptName(num) {
        $.ajax({
            url: baseUrl + "app_clothCommomQuery.do?queryDept",
            type: "get",
            data: {
                dataGroupCode: dataGroupCode,
                deptNum: num,
                deptName: ""
            },
            success: function(data) {
                var data = JSON.parse(data);
                deptName = data.obj.obj[0].deptName;
                console.log(deptName);
                localStorage.setItem("initDeptName", deptName);
                location.href = "detailListAPP.html"
            },
            error: function(XMLHttpRequest) {
                var text = JSON.parse(XMLHttpRequest.responseText);
                mui.toast(text.message);
                return
            }
        })
    }
    // tab页
    $("#3").click(function() {
            location.href = "dirtyMainNAPP.html?" + deptNameInit + "&" + deptNumInit;
        })
        /**
         * @desc   点击返回按钮
         * @author huoke
         */
    mui("body").on("tap", "#back", function() {
        // console.log(".....")
        location.href = '../menuAPP.html';
    })

    /**
     * @desc   手机系统返回键
     * @author huoke
     */
    document.addEventListener("deviceready", onDeviceReady, false);

    function onDeviceReady() {
        document.addEventListener("backbutton", onBackKeyDown, false);
    }

    function onBackKeyDown() {
        location.href = '../menuAPP.html';
    }
</script>

</html>